<!DOCTYPE html>
<html>


<head>
  <title>Territorio Rosario</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Logo de la página -->
  <link rel="icon" href="https://KokeVazquez.github.io/Territorios_Capitan/logo.png" type="image/png">

  <!-- Estilos de Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <!-- Tarjeta al compartir link en WhatsApp -->
  <meta property="og:title" content="Mapa Rosario — Territorios">
  <meta property="og:description" content="Mapa interactivo para el Capitan.">
  <meta property="og:image" content="https://i.imgur.com/rCUv8TX.png">
  <meta property="og:url" content="https://KokeVazquez.github.io/Territorios_Capitan/?v=3">
  <meta property="og:type" content="website">
</head>

<style>
  /* ===========================
     === Base / Reset =========
     =========================== */
  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  /* ===========================
     === Mapa =================
     =========================== */
  #map {
    height: 100vh;
    width: 100vw;
    margin: 0;
    padding: 0;
  }

  /* =====================================
     === Menú izquierdo (selector) =======
     ===================================== */
  .menu {
    position: fixed;
    top: 1vh;
    left: 1vw;
    z-index: 1000;
    background: transparent;
    padding: 0.5em;
    border-radius: 8px;
  }

  /* =====================================
     === Menú derecho (Área Grande + Notas)
     ===================================== */
  .menu-derecha {
    position: fixed;
    top: 1%;
    right: 1%;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 2vh;
    margin: 0;
    padding: 0;
  }

  .menu-derecha button {
    padding: clamp(0.5vh, 1.2vw, 1.5vh) clamp(1vw, 2vw, 3vw);
    font-size: clamp(0.8rem, 1.5vw, 1.2rem);
    border-radius: 5px;
    cursor: pointer;
    box-sizing: border-box;
    width: 100%;
    max-width: 250px;
  }








  /* ====================================================================================================================================
   === Botones estilo "Liquid Glass" realista iOS con letra tipo iPhone ===
   =================================================== */
  button,
  #btnAreaGrande,
  #btnMostrarTodasNotas,
  #btnTerritoriosTerminados,
  #registrarTerritorioBtn,
  #backupBtn,
  #restoreBtn {
    position: relative;
    background: rgba(24, 23, 23, 0.068);
    border: 2px solid rgba(253, 253, 253, 0.199);
    backdrop-filter: blur(5px) saturate(20%);
    -webkit-backdrop-filter: blur(2px) saturate(20%);
    border-radius: 50px;
    color: white;
    /* ======================================
     Letra tipo iPhone moderna
     ====================================== */
    font-family: "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-weight: 600;
    /* más delgada y elegante */
    font-size: 1rem;
    /* ajusta si quieres más grande o más pequeña */
    -webkit-font-smoothing: antialiased;
    /* suaviza bordes de fuente */
    -moz-osx-font-smoothing: grayscale;
    box-shadow:
      inset 0 0px 0px rgba(255, 255, 255, 0.6),
      0 4px 10px rgba(0, 0, 0, 0.25),
      0 0 25px rgba(255, 255, 255, 0.03);
    transition: all 0.25s ease;
    overflow: hidden;
    outline: none;
    /* quita el contorno azul al hacer click */
    -webkit-tap-highlight-color: transparent;
    /* quita el highlight en móviles iOS/Android */
  }

  /* Brillo superior (reflejo) */
  button::after,
  #btnAreaGrande::after,
  #btnMostrarTodasNotas::after,
  #btnTerritoriosTerminados::after,
  #registrarTerritorioBtn::after,
  #backupBtn::after,
  #restoreBtn::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 45%;
    background: linear-gradient(to bottom,
        rgba(255, 255, 255, 0.35),
        rgba(255, 255, 255, 0.05));
    border-top-left-radius: inherit;
    border-top-right-radius: inherit;
    pointer-events: none;
  }

  /* Hover: más luz, efecto gel */
  button:hover,
  #btnAreaGrande:hover,
  #btnMostrarTodasNotas:hover,
  #btnTerritoriosTerminados:hover,
  #registrarTerritorioBtn:hover,
  #backupBtn:hover,
  #restoreBtn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px) scale(1.05);
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.8),
      0 6px 20px rgba(0, 0, 0, 0.35),
      0 0 30px rgba(255, 255, 255, 0.2);
  }

  /* Click: rebote suave */
  button:active,
  #btnAreaGrande:active,
  #btnMostrarTodasNotas:active,
  #btnTerritoriosTerminados:active,
  #registrarTerritorioBtn:active,
  #backupBtn:active,
  #restoreBtn:active {
    transform: scale(0.96);
    background: rgba(255, 255, 255, 0.25);
    box-shadow:
      inset 0 2px 3px rgba(255, 255, 255, 0.9),
      0 3px 8px rgba(0, 0, 0, 0.4);
  }

  /* =======================================================================================================================================







  /* ===========================
   === SELECTS Liquid Glass ===
   =========================== */
  .custom-select {
    position: relative;
    cursor: pointer;
    width: 100%;
    max-width: 250px;
    box-sizing: border-box;
    font-family: "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-weight: 600;
  }

  /* Caja del selector */
  .custom-select .selected {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: clamp(0.5vh, 1vw, 1.2vh) clamp(1vw, 2vw, 2vw);
    padding-right: clamp(2vw, 3vw, 2.5vw);
    font-size: clamp(0.8rem, 1.5vw, 1.2rem);
    border-radius: 20px;
    background: rgba(70, 128, 182, 0.37);
    backdrop-filter: blur(5px) saturate(150%);
    -webkit-backdrop-filter: blur(5px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.151);
    color: #fff;
    user-select: none;
    transition: all 0.25s ease-in-out;
    background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 1vw center;
    background-size: 16px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.6), 0 4px 10px rgba(0, 0, 0, 0.25), 0 0 25px rgba(255, 255, 255, 0.05);
    outline: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* Hover estilo gel */
  .custom-select .selected:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.03);
    box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.8), 0 6px 20px rgba(0, 0, 0, 0.35);
  }

  /* Click: efecto burbuja */
  .custom-select .selected:active {
    transform: scale(0.97);
    background: rgba(255, 255, 255, 0.3);
  }

  /* Lista de opciones */
  .custom-select .options {
    list-style: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(53, 52, 52, 0.15);
    backdrop-filter: blur(5px) saturate(150%);
    -webkit-backdrop-filter: blur(5px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    max-height: 60vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    z-index: 10000;
    margin-top: 0.5vh;
    padding: 0;
    box-sizing: border-box;
    transition: all 0.2s ease;
    opacity: 0;
    transform: scaleY(0.8);
    transform-origin: top;
    pointer-events: none;
  }

  /* Abrir opciones */
  .custom-select.active .options {
    opacity: 1;
    transform: scaleY(1);
    pointer-events: auto;
    display: block;
  }

  /* Cada opción */
  .custom-select .options li {
    padding: clamp(0.5vh, 1vw, 1.2vh) clamp(1vw, 2vw, 2vw);
    font-size: clamp(0.8rem, 1.5vw, 1.2rem);
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s ease-in-out;
    box-sizing: border-box;
    color: #fff;
  }

  /* Hover opción */
  .custom-select .options li:hover {
    background: rgba(255, 255, 255, 0.25);
    color: #000;
    transform: scale(1.03);
    border-radius: 15px;
  }

  /* Click opción */
  .custom-select .options li:active {
    transform: scale(0.97);
    background: rgba(255, 255, 255, 0.3);
    color: #fff;
  }

  /* Responsive muy pequeño */
  @media (max-width: 360px) {

    .custom-select,
    .custom-select .selected,
    .custom-select .options li {
      font-size: 0.95rem;
      padding: 1vh 1vw;
    }
  }


  /* ===========================
     === Responsivo móvil ======
     =========================== */
  @media (max-width: 480px) {
    .menu-derecha button {
      font-size: 3vw !important;
      padding: 2vh 2vw !important;
      min-width: 100px !important;
    }

    #selectorTerritorios,
    #filtroMes {
      font-size: 3vw !important;
      padding: 2vh 1vw !important;
      padding-right: 4vw !important;
      background-position: right 3vw center;
    }
  }



  /* ===========================
     === Loader ===============
     =========================== */
  #loader {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #loader img {
    width: 120px;
    height: auto;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.8;
    }

    50% {
      transform: scale(1.1);
      opacity: 1;
    }

    100% {
      transform: scale(1);
      opacity: 0.8;
    }
  }

  /* ===========================
     === Otros estilos ========
     =========================== */
  .leaflet-draw.leaflet-control {
    margin-top: 5vh !important;
  }

  .etiqueta-poligono {
    display: inline-block;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50px;
    padding: 2px 10px;
    font-weight: 500;
    font-size: 15px;
    color: black;
    text-align: center;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    white-space: nowrap;
  }

  .menu-contextual {
    background: rgba(0, 0, 0, 0.062);
    /* efecto vidrio */
    backdrop-filter: blur(5px) saturate(150%);
    -webkit-backdrop-filter: blur(5px) saturate(150%);
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    color: black;
    /* letras visibles */
    padding: 8px;
    font-size: 14px;
    user-select: none;
  }

  .menu-contextual button {
    background: rgba(255, 255, 255, 0.15);
    /* más transparente para efecto vidrio */
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    width: 100%;
    color: #fff;
    /* letras blancas visibles sobre el fondo oscuro */
    font-family: "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-weight: 600;
    backdrop-filter: blur(6px) saturate(180%);
    -webkit-backdrop-filter: blur(6px) saturate(180%);
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.6),
      0 4px 10px rgba(0, 0, 0, 0.25),
      0 0 20px rgba(255, 255, 255, 0.03);
    transition: all 0.25s ease;
  }

  .menu-contextual button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px) scale(1.05);
    box-shadow:
      inset 0 2px 3px rgba(255, 255, 255, 0.8),
      0 6px 15px rgba(0, 0, 0, 0.35),
      0 0 25px rgba(255, 255, 255, 0.1);
  }

  .menu-contextual button:active {
    transform: scale(0.96);
    background: rgba(255, 255, 255, 0.25);
    box-shadow:
      inset 0 2px 3px rgba(255, 255, 255, 0.9),
      0 3px 8px rgba(0, 0, 0, 0.4);
  }


  .etiquetaTerritorio {
    background: none;
    border-radius: 50%;
    padding: 5px 1px;
    font-weight: bold;
    font-size: 20px;
    color: black;
    text-align: center;
    pointer-events: none;
    box-shadow: 0 0px 0px black;
  }

  /* ✅ Evitar zoom automático en Safari (iPhone) */
  input,
  select,
  textarea,
  button {
    font-size: 16px !important;
  }


  /* Contenedor fijo en la esquina inferior izquierda */
  .btn-container {
    position: fixed;
    bottom: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: clamp(4px, 1vh, 8px);
    z-index: 9999;
  }

  /* Botones mini responsivos */
  .mini-btn {
    width: clamp(80px, 20vw, 120px);
    font-size: clamp(10px, 2vw, 12px);
    padding: clamp(4px, 0.8vh, 6px) clamp(6px, 1vw, 8px);
    border-radius: 6px;
    border: none;
    background: #2c3e50;
    color: white;
    cursor: pointer;
    opacity: 0.75;
    transition: all 0.2s ease;
  }

  .mini-btn:hover {
    opacity: 1;
    transform: scale(1.05);
    background: #34495e;
  }




  /* ============================================
   === Estilo responsive para territorios terminados ===
   ============================================ */
  .registroItem {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    background: #f8f8f8;
    padding: 12px 14px;
    border-radius: 8px;
    margin: 10px 0;
    position: relative;
    color: #000;
    font-size: 15px;
    line-height: 1.4;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.1s ease;
  }

  .registroItem:hover {
    transform: scale(1.01);
  }

  .registroItem strong {
    display: block;
    margin-bottom: 3px;
    color: #333;
  }

  .registroItem .nombreCapitan,
  .registroItem .fechaRegistro {
    font-weight: bold;
    color: #d32f2f;
  }

  .registroItem .botonesAccion {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 8px;
    width: 100%;
  }

  .registroItem .botonesAccion button {
    flex: 1;
    padding: 6px 10px;
    font-size: 15px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .registroItem .btnEditarInline {
    background: #1976d2;
  }

  .registroItem .btnEliminar {
    background: #e53935;
  }

  .registroItem .btnNota {
    background: #ffb74d;
    color: #222;
  }

  .registroItem .btnEditarInline:hover {
    background: #1565c0;
  }

  .registroItem .btnEliminar:hover {
    background: #c62828;
  }

  .registroItem .btnNota:hover {
    background: #ffa726;
  }

  /* Indicador de nota */
  .registroItem .indicadorNota {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 8px;
    height: 8px;
    background: black;
    border-radius: 50%;
  }

  /* Ajuste especial para pantallas pequeñas */
  @media (max-width: 600px) {
    .registroItem {
      font-size: 14px;
      padding: 10px;
    }

    .registroItem .botonesAccion button {
      font-size: 14px;
      padding: 8px;
    }
  }





  /* MENU DE HAMBURGUESA */


  .hamburger-menu {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
  }

  .hamburger-icon {
    font-size: 24px;
    background: #333;
    color: white;
    border: none;
    border-radius: 8px;
    width: 50px;
    height: 50px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .hamburger-icon:hover {
    background: #555;
  }

  .menu-panel {
    position: fixed;
    bottom: 80px;
    left: 20px;
    background: rgba(40, 40, 40, 0.95);
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transform: translateX(-150%);
    transition: transform 0.3s ease;
  }

  .menu-panel button {
    background: #444;
    color: #fff;
    border: none;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-align: left;
  }

  .menu-panel button:hover {
    background: #666;
  }

  .menu-panel.show {
    transform: translateX(0);
  }
















  /* ==============================================================================================================================
    // === PARA QUE NO SE SELECCIONE TEXTO EN SAFARI ===
    // ==============================================================================================================================


  /* Evita selección de texto o el cuadro azul en Safari */
  * {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    /* bloquea el menú contextual azul de iOS */
  }

  /* Pero permite seleccionar texto solo donde sí lo necesitas, por ejemplo dentro de inputs o textareas */
  input,
  textarea {
    -webkit-user-select: text;
    user-select: text;
    -webkit-touch-callout: default;
  }
</style>







<script>
  // 🔧 Solución automática para Safari iPhone (reset de zoom)
  window.addEventListener("focusout", function () {
    // Solo en dispositivos iOS
    if (/iP(ad|hone|od)/.test(navigator.userAgent)) {
      setTimeout(() => {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        window.scrollTo(0, 0);
        document.body.style.zoom = "1"; // fuerza recalibrar
      }, 300);
    }
  });






</script>

<!-- Menú hamburguesa -->
<div class="hamburger-menu">
  <button id="hamburger-btn" class="hamburger-icon">☰</button>
  <div id="menu-panel" class="menu-panel">
    <button id="btnCopiaSeguridad">Copia de seguridad</button>
    <button id="btnRestaurar">Restaurar copia</button>
    <button id="btnUbicacion">Ubicación</button>
  </div>
</div>





<body>
  <!-- HTML -->
  <div class="menu">
    <!-- Custom select -->
    <div class="custom-select" id="customSelectorTerritorios">
      <div class="selected">-- Selecciona un territorio --</div>
      <ul class="options">
        <li data-value="territorio1">Territorio 1</li>
        <li data-value="territorio2">Territorio 2</li>
        <li data-value="territorio3">Territorio 3</li>
        <li data-value="territorio4">Territorio 4</li>
        <li data-value="territorio5">Territorio 5</li>
        <li data-value="territorio6">Territorio 6</li>
        <li data-value="territorio7">Territorio 7</li>
        <li data-value="territorio8">Territorio 8</li>
        <li data-value="territorio9">Territorio 9</li>
        <li data-value="territorio10">Territorio 10</li>
        <li data-value="territorio11">Territorio 11</li>
        <li data-value="territorio12">Territorio 12</li>
        <li data-value="territorio13">Territorio 13</li>
        <li data-value="territorio14">Territorio 14</li>
        <li data-value="territorio15">Territorio 15</li>
        <li data-value="territorio16">Territorio 16</li>
        <li data-value="territorio17">Territorio 17</li>
        <li data-value="territorio18">Territorio 18</li>
        <li data-value="territorio19">Territorio 19</li>
        <li data-value="territorio20">Territorio 20</li>
        <li data-value="territorio21">Territorio 21</li>
        <li data-value="territorio22">Territorio 22</li>
        <li data-value="territorio23">Territorio 23</li>
        <li data-value="territorio24">Territorio 24</li>
        <li data-value="territorio25">Territorio 25</li>
        <li data-value="territorio26">Territorio 26</li>
        <li data-value="territorio27">Territorio 27</li>
        <li data-value="territorio28">Territorio 28</li>
        <li data-value="territorio29">Territorio 29</li>
        <li data-value="territorio30">Territorio 30</li>
        <li data-value="territorio31">Territorio 31</li>
        <li data-value="territorio32">Territorio 32</li>
        <li data-value="territorio33">Territorio 33</li>
        <li data-value="territorio34">Territorio 34</li>
        <li data-value="territorio35">Territorio 35</li>
        <li data-value="territorio36">Territorio 36</li>
        <li data-value="territorio37">Territorio 37</li>
        <li data-value="territorio38">Territorio 38</li>
        <li data-value="territorio39">Territorio 39</li>
        <li data-value="territorio40">Territorio 40</li>
        <li data-value="territorio41">Territorio 41</li>
        <li data-value="territorio42">Territorio 42</li>
        <li data-value="territorio43">Territorio 43</li>
        <li data-value="territorio44">Territorio 44</li>
        <li data-value="territorio45">Territorio 45</li>
        <li data-value="territorio46">Territorio 46</li>
        <li data-value="territorio47">Territorio 47</li>
        <li data-value="territorio48">Territorio 48</li>
        <li data-value="territorio49">Territorio 49</li>
        <li data-value="territorio50">Territorio 50</li>
        <li data-value="territorio51">Territorio 51</li>
        <li data-value="territorio52">Territorio 52</li>
        <li data-value="territorio53">Territorio 53</li>
        <li data-value="territorio54">Territorio 54</li>
        <li data-value="territorio55">Territorio 55</li>
        <li data-value="territorio56">Territorio 56</li>
        <li data-value="territorio57">Territorio 57</li>
        <li data-value="territorio58">Territorio 58</li>
        <li data-value="territorio59">Territorio 59</li>
        <li data-value="territorio60">Territorio 60</li>
        <li data-value="territorio61">Territorio 61</li>
        <li data-value="territorio62">Territorio 62</li>
        <li data-value="territorio63">Territorio 63</li>
        <li data-value="territorio64">Territorio 64</li>
        <li data-value="territorio65">Territorio 65</li>
        <li data-value="territorio66">Territorio 66</li>
        <li data-value="territorio67">Territorio 67</li>
        <li data-value="territorio68">Territorio 68</li>
        <li data-value="territorio69">Territorio 69</li>
        <li data-value="territorio70">Territorio 70</li>
        <li data-value="territorio71">Territorio 71</li>
        <li data-value="territorio72">Territorio 72</li>
        <li data-value="territorio73">Territorio 73</li>
        <li data-value="territorio74">Territorio 74</li>
        <li data-value="territorio75">Territorio 75</li>
        <li data-value="territorio76">Territorio 76</li>
        <li data-value="territorio77">Territorio 77</li>
        <li data-value="territorio78">Territorio 78</li>
        <li data-value="territorio79">Territorio 79</li>
        <li data-value="territorio80">Territorio 80</li>
        <li data-value="territorio81">Territorio 81</li>
        <li data-value="territorio82">Territorio 82</li>
        <li data-value="territorio83">Territorio 83</li>
        <li data-value="territorio84">Territorio 84</li>
      </ul>
    </div>

    <!-- Hidden original select -->
    <select id="selectorTerritorios" style="display:none;">
      <option value="">-- Selecciona un territorio --</option>
      <option value="territorio1">Territorio 1</option>
      <option value="territorio2">Territorio 2</option>
      <option value="territorio3">Territorio 3</option>
      <option value="territorio4">Territorio 4</option>
      <option value="territorio5">Territorio 5</option>
      <option value="territorio6">Territorio 6</option>
      <option value="territorio7">Territorio 7</option>
      <option value="territorio8">Territorio 8</option>
      <option value="territorio9">Territorio 9</option>
      <option value="territorio10">Territorio 10</option>
      <option value="territorio11">Territorio 11</option>
      <option value="territorio12">Territorio 12</option>
      <option value="territorio13">Territorio 13</option>
      <option value="territorio14">Territorio 14</option>
      <option value="territorio15">Territorio 15</option>
      <option value="territorio16">Territorio 16</option>
      <option value="territorio17">Territorio 17</option>
      <option value="territorio18">Territorio 18</option>
      <option value="territorio19">Territorio 19</option>
      <option value="territorio20">Territorio 20</option>
      <option value="territorio21">Territorio 21</option>
      <option value="territorio22">Territorio 22</option>
      <option value="territorio23">Territorio 23</option>
      <option value="territorio24">Territorio 24</option>
      <option value="territorio25">Territorio 25</option>
      <option value="territorio26">Territorio 26</option>
      <option value="territorio27">Territorio 27</option>
      <option value="territorio28">Territorio 28</option>
      <option value="territorio29">Territorio 29</option>
      <option value="territorio30">Territorio 30</option>
      <option value="territorio31">Territorio 31</option>
      <option value="territorio32">Territorio 32</option>
      <option value="territorio33">Territorio 33</option>
      <option value="territorio34">Territorio 34</option>
      <option value="territorio35">Territorio 35</option>
      <option value="territorio36">Territorio 36</option>
      <option value="territorio37">Territorio 37</option>
      <option value="territorio38">Territorio 38</option>
      <option value="territorio39">Territorio 39</option>
      <option value="territorio40">Territorio 40</option>
      <option value="territorio41">Territorio 41</option>
      <option value="territorio42">Territorio 42</option>
      <option value="territorio43">Territorio 43</option>
      <option value="territorio44">Territorio 44</option>
      <option value="territorio45">Territorio 45</option>
      <option value="territorio46">Territorio 46</option>
      <option value="territorio47">Territorio 47</option>
      <option value="territorio48">Territorio 48</option>
      <option value="territorio49">Territorio 49</option>
      <option value="territorio50">Territorio 50</option>
      <option value="territorio51">Territorio 51</option>
      <option value="territorio52">Territorio 52</option>
      <option value="territorio53">Territorio 53</option>
      <option value="territorio54">Territorio 54</option>
      <option value="territorio55">Territorio 55</option>
      <option value="territorio56">Territorio 56</option>
      <option value="territorio57">Territorio 57</option>
      <option value="territorio58">Territorio 58</option>
      <option value="territorio59">Territorio 59</option>
      <option value="territorio60">Territorio 60</option>
      <option value="territorio61">Territorio 61</option>
      <option value="territorio62">Territorio 62</option>
      <option value="territorio63">Territorio 63</option>
      <option value="territorio64">Territorio 64</option>
      <option value="territorio65">Territorio 65</option>
      <option value="territorio66">Territorio 66</option>
      <option value="territorio67">Territorio 67</option>
      <option value="territorio68">Territorio 68</option>
      <option value="territorio69">Territorio 69</option>
      <option value="territorio70">Territorio 70</option>
      <option value="territorio71">Territorio 71</option>
      <option value="territorio72">Territorio 72</option>
      <option value="territorio73">Territorio 73</option>
      <option value="territorio74">Territorio 74</option>
      <option value="territorio75">Territorio 75</option>
      <option value="territorio76">Territorio 76</option>
      <option value="territorio77">Territorio 77</option>
      <option value="territorio78">Territorio 78</option>
      <option value="territorio79">Territorio 79</option>
      <option value="territorio80">Territorio 80</option>
      <option value="territorio81">Territorio 81</option>
      <option value="territorio82">Territorio 82</option>
      <option value="territorio83">Territorio 83</option>
      <option value="territorio84">Territorio 84</option>
    </select>
  </div>


  <div class="menu-derecha">
    <button id="btnAreaGrande">Área Grande</button>
    <button id="btnMostrarTodasNotas">Notas</button>
    <button id="btnTerritoriosTerminados">Territorios terminados</button>
    <!-- Botón para registrar territorio completo -->
    <button id="registrarTerritorioBtn">
      Registrar
    </button>


















    <!-- Select personalizado -->
    <div class="custom-select" id="customFiltroMes">
      <div class="selected">Mes</div>
      <ul class="options">
        <li data-value="inicio">Mes</li>
        <li data-value="todos">Todos los meses</li>
        <li data-value="01">Enero</li>
        <li data-value="02">Febrero</li>
        <li data-value="03">Marzo</li>
        <li data-value="04">Abril</li>
        <li data-value="05">Mayo</li>
        <li data-value="06">Junio</li>
        <li data-value="07">Julio</li>
        <li data-value="08">Agosto</li>
        <li data-value="09">Septiembre</li>
        <li data-value="10">Octubre</li>
        <li data-value="11">Noviembre</li>
        <li data-value="12">Diciembre</li>
      </ul>
    </div>

    <!-- Select original oculto -->
    <select id="filtroMes" style="display:none;">
      <option value="inicio">Mes</option>
      <option value="todos">Todos los meses</option>
      <option value="01">Enero</option>
      <option value="02">Febrero</option>
      <option value="03">Marzo</option>
      <option value="04">Abril</option>
      <option value="05">Mayo</option>
      <option value="06">Junio</option>
      <option value="07">Julio</option>
      <option value="08">Agosto</option>
      <option value="09">Septiembre</option>
      <option value="10">Octubre</option>
      <option value="11">Noviembre</option>
      <option value="12">Diciembre</option>
    </select>



  </div>
  <!-- CUADRO DE PORCENTAJE -->
  <div id="cuadroPorcentaje" style="
  position: fixed;
  bottom: clamp(12px, 2vh, 20px);
  right: clamp(12px, 3vw, 25px);
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 50px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  z-index: 10000;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: clamp(0.9rem, 2vw, 1rem);
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  user-select: none;
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
">
    <span style="font-weight: 600; color: #333;">Avance:</span>
    <span id="porcentajeAvance" style="
    font-weight: bold;
    color: #1a73e8;
    font-size: clamp(1rem, 2.4vw, 1.2rem);
  ">0.0%</span>
  </div>










  <!--BOTON PARA CREAR POLIGONOS-->

  <!-- <button onclick="exportarPoligonos()" style="position: absolute; top: 100px; right: 20px; z-index: 1000;">
    📤 Exportar
  </button>
-->





  <div id="map"></div>
  <div id="menuContextual" class="menu-contextual" style="display:none; position:absolute; z-index:2000;"></div>
  <div id="loader">
    <img src="JW_Logo.png" alt="Cargando..." />
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>






  <script>


    const TOTAL_CUADRAS = 389; // número total de polígonos/cuadras




    // ==============================================================================================================================
    // === Inicialización del mapa ===
    // ==============================================================================================================================
    var map = L.map("map", {
      maxZoom: 22,
      zoomControl: false,
      doubleClickZoom: false
    });
    var boundsIniciales = L.latLngBounds([[28.600, -106.075], [28.618, -106.070]]);
    map.fitBounds(boundsIniciales, { padding: [5, 5] });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
      maxZoom: 22
    }).addTo(map);
    //========================================================================================================================================//







    // ==============================================================================================================================
    // === Variables globales ===
    // ==============================================================================================================================
    let territorioActivo = null;
    window.todosLosTerritorios = [];
    let etiquetasActivas = [];
    window.indicadoresNotas = [];
    var overlayGris; //Para boton de area grande==========================================================================

    //========================================================================================================================================//








    /*
        // ================================
        // === Notas / Capitanes ===          BORRO ESTA FUNCION Y PUEDO SEGUIR AÑADIENDO NOTAS... PENDIENTE POR INVESTIGAR
        // ================================
        function anadirNota(pol) {
          let territorioId = pol._territorioId || "territorio";
          let notasGuardadas = JSON.parse(localStorage.getItem(territorioId + "_notas") || "{}");
          let nuevaNota = prompt("Escribe el nombre del capitán o nota:", notasGuardadas[pol._id] || "");
          if (nuevaNota !== null) {
            notasGuardadas[pol._id] = nuevaNota;
            localStorage.setItem(territorioId + "_notas", JSON.stringify(notasGuardadas));
            mostrarIndicadoresNotas();
          }
        }
    
        function mostrarNota(pol) {
          let territorioId = pol._territorioId || "territorio";
          let notasGuardadas = JSON.parse(localStorage.getItem(territorioId + "_notas") || "{}");
          let nota = notasGuardadas[pol._id];
          alert(nota ? "Capitán/nota: " + nota : "No hay información registrada.");
        }
    
    */








    // =========================================================================================================================
    // === MOSTRAR ICONOS CON CLICK IZQUIERDO ===
    // =========================================================================================================================
    let notasMostradas = false;

    document.getElementById("btnMostrarTodasNotas").addEventListener("click", function () {
      if (!notasMostradas) {
        window.todosLosTerritorios.forEach(territorio => {
          const notasTerritorio = JSON.parse(localStorage.getItem(territorio._id + "_notas") || "{}");

          territorio.eachLayer(function (pol) {
            const notasPol = notasTerritorio[pol._id];
            if (notasPol && notasPol.length > 0) {
              // Centroide
              const latlngs = pol.getLatLngs()[0];
              const coords = latlngs.map(ll => [ll.lng, ll.lat]);
              coords.push([coords[0][0], coords[0][1]]);
              const centroide = turf.centroid(turf.polygon([coords]));
              const cLat = centroide.geometry.coordinates[1];
              const cLng = centroide.geometry.coordinates[0];

              // Marcador
              const marker = L.marker([cLat, cLng], {
                interactive: false,
                icon: L.divIcon({
                  className: "indicador-nota",
                  html: "📒",
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                })
              }).addTo(map);

              window.indicadoresNotas.push(marker);
            }
          });
        });
        notasMostradas = true;
      } else {
        window.indicadoresNotas.forEach(m => map.removeLayer(m));
        window.indicadoresNotas = [];
        notasMostradas = false;
      }
    });

    // =========================================================================================================================
    // === MOSTRAR TODAS LAS NOTAS EN MODAL (CLICK DERECHO O MANTENER) CON EDITAR/ELIMINAR POP-UP ===
    // =========================================================================================================================
    const modalNotas = document.createElement("div");
    modalNotas.id = "modalNotas";
    modalNotas.style.position = "fixed";
    modalNotas.style.top = "0";
    modalNotas.style.left = "0";
    modalNotas.style.width = "100%";
    modalNotas.style.height = "100%";
    modalNotas.style.backgroundColor = "rgba(0,0,0,0.5)";
    modalNotas.style.display = "none";
    modalNotas.style.justifyContent = "center";
    modalNotas.style.alignItems = "center";
    modalNotas.style.zIndex = "9999";

    const modalContent = document.createElement("div");
    modalContent.style.backgroundColor = "#fff";
    modalContent.style.padding = "20px";
    modalContent.style.borderRadius = "10px";
    modalContent.style.maxHeight = "80%";
    modalContent.style.overflowY = "auto";
    modalContent.style.width = "80%";
    modalContent.style.boxShadow = "0 0 15px rgba(0,0,0,0.3)";
    modalNotas.appendChild(modalContent);
    document.body.appendChild(modalNotas);

    modalNotas.addEventListener("click", (e) => {
      if (e.target === modalNotas) modalNotas.style.display = "none";
    });

    // === Crear mini pop-up para editar/eliminar ===
    const miniPopup = document.createElement("div");
    miniPopup.style.position = "fixed";
    miniPopup.style.top = "50%";
    miniPopup.style.left = "50%";
    miniPopup.style.transform = "translate(-50%, -50%)";
    miniPopup.style.backgroundColor = "#fff";
    miniPopup.style.padding = "20px";
    miniPopup.style.borderRadius = "10px";
    miniPopup.style.boxShadow = "0 0 15px rgba(0,0,0,0.3)";
    miniPopup.style.zIndex = "10000";
    miniPopup.style.display = "none";
    document.body.appendChild(miniPopup);

    function mostrarPopup(contentHtml) {
      miniPopup.innerHTML = contentHtml;
      miniPopup.style.display = "block";
    }

    // === Función para cerrar el mini popup ===
    function cerrarPopup() {
      miniPopup.style.display = "none";
    }

    document.getElementById("btnMostrarTodasNotas").addEventListener("contextmenu", function (e) {
      e.preventDefault();

      let todasLasNotas = [];

      window.todosLosTerritorios.forEach(territorio => {
        const notasTerritorio = JSON.parse(localStorage.getItem(territorio._id + "_notas") || "{}");

        territorio.eachLayer(function (pol) {
          const notasPol = notasTerritorio[pol._id];
          if (notasPol && notasPol.length > 0) {
            notasPol.forEach((nota, index) => {
              todasLasNotas.push({
                territorioId: territorio._id,
                territorio: territorio.options?.name || territorio._id,
                cuadra: pol._id,
                contenido: typeof nota === "string" ? nota : nota.texto || JSON.stringify(nota),
                index: index
              });
            });
          }
        });
      });

      if (todasLasNotas.length === 0) {
        alert("No hay notas registradas.");
        return;
      }

      modalContent.innerHTML = "<h2>Todas las Notas Registradas</h2><hr>";
      // Botón para eliminar todas las notas
      const btnEliminarTodas = document.createElement("button");
      btnEliminarTodas.textContent = "Eliminar Todas las Notas";
      btnEliminarTodas.style.backgroundColor = "#f44336";
      btnEliminarTodas.style.color = "#fff";
      btnEliminarTodas.style.border = "none";
      btnEliminarTodas.style.padding = "8px 12px";
      btnEliminarTodas.style.borderRadius = "5px";
      btnEliminarTodas.style.cursor = "pointer";
      btnEliminarTodas.style.marginBottom = "10px";

      btnEliminarTodas.addEventListener("click", () => {
        mostrarPopup(`
    <h3>Confirmar Eliminación</h3>
    <p>¿Seguro que quieres eliminar <b>todas</b> las notas?</p>
    <button id="confirmarEliminarTodasBtn" style="background-color:#f44336;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Sí</button>
    <button id="cancelarEliminarTodasBtn" style="background-color:#ccc;color:#000;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">No</button>
  `);

        document.getElementById("confirmarEliminarTodasBtn").addEventListener("click", () => {
          // Vaciar todas las notas de todos los territorios
          window.todosLosTerritorios.forEach(territorio => {
            localStorage.removeItem(territorio._id + "_notas");
          });
          modalContent.innerHTML = "<h2>Todas las Notas Registradas</h2><hr><p>No hay notas registradas.</p>";
          cerrarPopup();
        });

        document.getElementById("cancelarEliminarTodasBtn").addEventListener("click", cerrarPopup);
      });

      modalContent.appendChild(btnEliminarTodas);

      // Luego sigue el resto de tu código que recorre todasLasNotas y crea cada nota individual
      todasLasNotas.forEach(n => {
        // tu código existente para crear notaDiv, botones editar/eliminar...
      });

      todasLasNotas.forEach(n => {
        const notaDiv = document.createElement("div");
        notaDiv.style.marginBottom = "10px";
        notaDiv.style.padding = "10px";
        notaDiv.style.border = "1px solid #ccc";
        notaDiv.style.borderRadius = "8px";
        notaDiv.style.display = "flex";
        notaDiv.style.justifyContent = "space-between";
        notaDiv.style.alignItems = "center";

        const territorioNum = n.territorio.replace(/\D/g, '');
        const cuadraNum = n.cuadra.replace(/\D/g, '');

        const textoNota = document.createElement("div");
        textoNota.innerHTML = `<b>Territorio:</b> ${territorioNum} <br>
                           <b>Cuadra:</b> ${cuadraNum} <br>
                           <b>Nota:</b> <span style="color:red; font-weight:bold;" class="nota-texto">${n.contenido}</span>`;

        const botonesDiv = document.createElement("div");
        botonesDiv.style.display = "flex";
        botonesDiv.style.gap = "5px";

        // Botón Editar
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.style.backgroundColor = "#4CAF50";
        btnEditar.style.color = "#fff";
        btnEditar.style.border = "none";
        btnEditar.style.padding = "5px 10px";
        btnEditar.style.borderRadius = "5px";
        btnEditar.style.cursor = "pointer";
        btnEditar.addEventListener("click", () => {
          mostrarPopup(`
        <h3>Editar Nota</h3>
        <textarea id="editarNotaTextarea" style="width:100%; height:80px;">${n.contenido}</textarea><br><br>
        <button id="guardarNotaBtn" style="background-color:black;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Guardar</button>
        <button id="cancelarNotaBtn" style="background-color:#f44336;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Cancelar</button>
      `);

          document.getElementById("guardarNotaBtn").addEventListener("click", () => {
            const nuevoTexto = document.getElementById("editarNotaTextarea").value;
            const notasTerritorio = JSON.parse(localStorage.getItem(n.territorioId + "_notas") || "{}");
            notasTerritorio[n.cuadra][n.index] = nuevoTexto;
            localStorage.setItem(n.territorioId + "_notas", JSON.stringify(notasTerritorio));
            textoNota.querySelector(".nota-texto").textContent = nuevoTexto;
            cerrarPopup();
          });

          document.getElementById("cancelarNotaBtn").addEventListener("click", cerrarPopup);
        });

        // Botón Eliminar
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.style.backgroundColor = "#f44336";
        btnEliminar.style.color = "#fff";
        btnEliminar.style.border = "none";
        btnEliminar.style.padding = "5px 10px";
        btnEliminar.style.borderRadius = "5px";
        btnEliminar.style.cursor = "pointer";
        btnEliminar.addEventListener("click", () => {
          mostrarPopup(`
        <h3>Confirmar Eliminación</h3>
        <p>¿Seguro que quieres eliminar esta nota?</p>
        <button id="confirmarEliminarBtn" style="background-color:#f44336;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Sí</button>
        <button id="cancelarEliminarBtn" style="background-color:#ccc;color:#000;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">No</button>
      `);

          document.getElementById("confirmarEliminarBtn").addEventListener("click", () => {
            const notasTerritorio = JSON.parse(localStorage.getItem(n.territorioId + "_notas") || "{}");
            notasTerritorio[n.cuadra].splice(n.index, 1);
            localStorage.setItem(n.territorioId + "_notas", JSON.stringify(notasTerritorio));
            notaDiv.remove();
            cerrarPopup();
          });

          document.getElementById("cancelarEliminarBtn").addEventListener("click", cerrarPopup);
        });

        botonesDiv.appendChild(btnEditar);
        botonesDiv.appendChild(btnEliminar);

        notaDiv.appendChild(textoNota);
        notaDiv.appendChild(botonesDiv);
        modalContent.appendChild(notaDiv);
      });

      modalNotas.style.display = "flex";
    });

    // ==================== MANTENER PULSADO (compatible con iOS y Android) ====================
    let pressTimer;
    const btn = document.getElementById("btnMostrarTodasNotas");

    function iniciarPresion() {
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => {
        btn.dispatchEvent(new Event('contextmenu'));
      }, 800);
    }

    function cancelarPresion() {
      clearTimeout(pressTimer);
    }

    btn.addEventListener("mousedown", iniciarPresion);
    btn.addEventListener("mouseup", cancelarPresion);
    btn.addEventListener("mouseleave", cancelarPresion);

    // Soporte para pantallas táctiles (iOS incluido)
    btn.addEventListener("touchstart", iniciarPresion);
    btn.addEventListener("touchend", cancelarPresion);
    btn.addEventListener("touchcancel", cancelarPresion);












    // ================================================================================================================================
    // === Menú contextual ===
    // ================================================================================================================================

    // Para ocultar el menú contextual
    function ocultarMenu() {
      const menu = document.getElementById("menuContextual");
      if (menu) menu.style.display = "none"; // simplemente lo esconde
    }
    // Para mostrar el menú contextual en la posición donde se hizo clic
    function mostrarMenu(e, pol) {
      ocultarMenu(); // primero se asegura de que no haya otro menú abierto
      const menu = document.getElementById("menuContextual");
      if (!menu) return; // si no existe el contenedor, salir
      // Obtener coordenadas del clic o toque
      var x = e.originalEvent.clientX || (e.originalEvent.touches && e.originalEvent.touches[0].clientX);
      var y = e.originalEvent.clientY || (e.originalEvent.touches && e.originalEvent.touches[0].clientY);
      // Posicionar el menú en el lugar del clic
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block"; // mostrarlo
      // Rellenar el menú con botones específicos para el polígono clickeado
      menu.innerHTML = `
    <button onclick="window.open('${pol._link}', '_blank'); ocultarMenu();">📍 Ubicación</button>
    <button onclick="anadirNota(pol); ocultarMenu();">➕ Añadir nota</button>
    <button onclick="mostrarNota(pol); ocultarMenu();">📒 Notas</button>
  `;
    }
    // Para cerrar el menú si se hace clic en cualquier parte del mapa
    map.on("click", ocultarMenu);

    //========================================================================================================================================//







    // ================================================================================================================================
    // === Loader ===
    // ================================================================================================================================

    // Para mostrar un indicador de carga (loader)
    function mostrarLoader() {
      const loader = document.getElementById("loader"); // busca el elemento con id "loader"
      if (loader) loader.style.display = "flex"; // lo hace visible usando display flex
    }
    // Para ocultar el loader
    function ocultarLoader() {
      const loader = document.getElementById("loader"); // busca el mismo elemento
      if (loader) loader.style.display = "none"; // lo esconde
    }
    // Para mover el mapa a un área específica mostrando el loader mientras carga
    function flyWithLoader(bounds, callback) {
      mostrarLoader(); // primero muestra el loader
      map.flyToBounds(bounds, { padding: [20, 20] }); // mueve/centrar el mapa suavemente a los límites indicados
      map.once('moveend', function () { // espera a que termine la animación del mapa
        ocultarLoader(); // oculta el loader cuando terminó
        if (callback) callback(); // si se pasó una función, la ejecuta
      });
    }

    //========================================================================================================================================//








    // ====================================================REGISTRAR CAPITAN Y FILTRAR POR MES=================================================//

    // ================================
    // === BLOQUE 1: Registrar Capitán ===
    // ================================

    // Función para iniciar el registro de un capitán en un polígono
    function registrarCapitan(pol) {
      if (window.popupActivo || window.menuActivo) return; // evita abrir otro popup si hay menú activo
      window.popupActivo = true;      // marcamos que hay popup abierto
      popupRegistrarCapitan(pol);     // abre el popup personalizado
    }

    // Pop up, mensaje de confirmacion de registro 
    function mostrarPopupConfirmacionCentro(mensaje) {
      const popup = document.createElement("div");
      popup.innerText = mensaje;
      popup.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: #4caf50;
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    text-align: center;
    max-width: 80%;
  `;
      document.body.appendChild(popup);

      setTimeout(() => {
        popup.style.opacity = 1;
        popup.style.transform = "translate(-50%, -50%) scale(1)";
      }, 10);

      setTimeout(() => {
        popup.style.opacity = 0;
        popup.style.transform = "translate(-50%, -50%) scale(0.8)";
        setTimeout(() => {
          if (document.body.contains(popup)) document.body.removeChild(popup);
        }, 300);
      }, 2000);
    }

    // ================================
    // === BLOQUE 2: Popup personalizado para registrar capitán ===
    // ================================
    function popupRegistrarCapitan(pol) {
      const territorioId = pol._territorioId || "territorio";

      // Crear el modal (popup oscuro de fondo)
      const modal = document.createElement("div");
      modal.style.cssText = `
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
    z-index: 9999;
  `;

      // Contenido del popup con inputs y botones
      modal.innerHTML = `
  <div style="
    background:white; padding:25px; border-radius:12px; width:300px; text-align:center;
    box-shadow:0 5px 20px rgba(0,0,0,0.3); position:relative;
  ">
    <button id="cerrarPopupCapitan" style="
      position:absolute; top:8px; right:8px; font-size:18px; border:none; background:none; cursor:pointer;">✖</button>
    <h3 style="margin-bottom:15px;">Registrar Capitán</h3>
    <input id="inputCapitan" placeholder="Nombre del capitán" style="width:90%; padding:6px; margin-bottom:10px;"/>
    <input id="inputFecha" type="date" style="width:90%; padding:6px; margin-bottom:10px;"/>
    <textarea id="inputComentario" placeholder="Comentario (opcional)" style="width:90%; padding:6px; margin-bottom:15px;"></textarea>
    <button id="guardarCapitan" style="
      padding:8px 15px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer;
    ">Guardar</button>
  </div>
`;


      document.body.appendChild(modal);

      // ================================
      // === Cerrar popup ===
      // ================================
      modal.querySelector("#cerrarPopupCapitan").addEventListener("click", () => {
        if (document.body.contains(modal)) document.body.removeChild(modal);
        window.popupActivo = false; // liberamos popup activo
      });

      // ================================
      // === Guardar datos del capitán ===
      // ================================
      modal.querySelector("#guardarCapitan").addEventListener("click", () => {
        const capitan = modal.querySelector("#inputCapitan").value.trim();
        const fecha = modal.querySelector("#inputFecha").value.trim();
        const comentario = modal.querySelector("#inputComentario").value.trim();

        if (!capitan || !fecha) return alert("Ingresa nombre y fecha");

        let registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");
        if (!registros[pol._id]) registros[pol._id] = [];

        // Revisar si ya hay registro para esa fecha
        const registrosPol = registros[pol._id] || [];
        const existe = Object.values(registros).some(arr =>
          arr.some(reg => {
            const fechaMatch = reg.match(/\| Fecha:\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/);
            return fechaMatch && fechaMatch[1] === fecha;
          })
        );

        if (existe) {
          // Mostrar popup de registro existente
          const popupExistente = document.createElement("div");
          popupExistente.style.cssText = `
    position: fixed; top:50%; left:50%; transform: translate(-50%, -50%);
    background:#f44336; color:white; padding:20px; border-radius:10px; z-index:10000; max-width:300px; text-align:center;
  `;
          popupExistente.innerHTML = `
    <p>Ya hay un registro existente para esta fecha.</p>
    <button id="verRegistroExistente" style="padding:6px 12px;margin:5px;background:#fff;color:#f44336;border:none;border-radius:6px;cursor:pointer;">Ver</button>
    <button id="cerrarPopupExistente" style="padding:6px 12px;margin:5px;background:#fff;color:#f44336;border:none;border-radius:6px;cursor:pointer;">Cerrar</button>
  `;
          document.body.appendChild(popupExistente);

          popupExistente.querySelector("#cerrarPopupExistente").addEventListener("click", () => {
            if (document.body.contains(popupExistente)) document.body.removeChild(popupExistente);
          });

          popupExistente.querySelector("#verRegistroExistente").addEventListener("click", () => {
            const regExist = registrosPol.find(reg => reg.includes(`| Fecha: ${fecha}`));

            const modalVer = document.createElement("div");
            modalVer.style.cssText = `
      position: fixed; top:50%; left:50%; transform: translate(-50%, -50%);
      background:#fff; color:#000; padding:20px; border-radius:10px; z-index:10001; max-width:300px; text-align:center;
    `;
            modalVer.innerHTML = `
      <p style="margin-bottom:10px;">${regExist}</p>
      <button id="borrarRegistroExistente" style="padding:6px 12px;margin:5px;background:#f44336;color:#fff;border:none;border-radius:6px;cursor:pointer;">Borrar</button>
      <button id="cerrarModalVer" style="padding:6px 12px;margin:5px;background:#777;color:#fff;border:none;border-radius:6px;cursor:pointer;">Cerrar</button>
    `;
            document.body.appendChild(modalVer);

            modalVer.querySelector("#cerrarModalVer").addEventListener("click", () => {
              if (document.body.contains(modalVer)) document.body.removeChild(modalVer);
            });

            modalVer.querySelector("#borrarRegistroExistente").addEventListener("click", () => {
              registros[pol._id] = registros[pol._id].filter(r => r !== regExist);
              localStorage.setItem(territorioId + "_capitanes", JSON.stringify(registros));
              if (document.body.contains(modalVer)) document.body.removeChild(modalVer);
              if (document.body.contains(popupExistente)) document.body.removeChild(popupExistente);
              mostrarPopupConfirmacionCentro("Registro eliminado con éxito!");
              pol._selected = false;
              pol.setStyle({ color: "blue", fillColor: "blue", fillOpacity: 0.5 });
              filtrarPorMes();
            });
          });

          return; // No registrar si ya existe
        }

        // Guardar registro si no existe duplicado
        registros[pol._id].push(`Capitán: ${capitan} | Fecha: ${fecha}${comentario ? " | Comentario: " + comentario : ""}`);
        localStorage.setItem(territorioId + "_capitanes", JSON.stringify(registros));

        if (document.body.contains(modal)) document.body.removeChild(modal);
        window.popupActivo = false;
        mostrarPopupConfirmacionCentro("Capitán registrado con éxito!");

        pol._selected = true;
        pol.setStyle({ color: "gray", fillColor: "gray", fillOpacity: 0.9 });

        // Agregar icono de palomita
        const latlngs = pol.getLatLngs()[0];
        const coords = latlngs.map(ll => [ll.lng, ll.lat]);
        coords.push([coords[0][0], coords[0][1]]);
        const centroide = turf.centroid(turf.polygon([coords]));
        const cLat = centroide.geometry.coordinates[1];
        const cLng = centroide.geometry.coordinates[0];
        const marker = L.marker([cLat, cLng], {
          interactive: false,
          icon: L.divIcon({ className: "indicador-nota", html: "✅", iconSize: [20, 20], iconAnchor: [10, 10] })
        }).addTo(map);
        window.indicadoresNotas.push(marker);

        filtrarPorMes();
      });
    }






    // ================================
    // === BLOQUE 3: Filtrar y mostrar iconos de palomita según mes y overlay gris con ventana ===
    // ================================
    function filtrarPorMes() {
      const mes = document.getElementById('filtroMes').value;
      const mostrarTodos = (mes === "todos");

      // ================================
      // Limpiar iconos anteriores
      // ================================
      window.indicadoresNotas.forEach(m => map.removeLayer(m));
      window.indicadoresNotas = [];

      // ================================
      // Limpiar overlay gris previo
      // ================================
      if (window.overlayGris) map.removeLayer(window.overlayGris);

      const mundo = [[90, -180], [90, 180], [-90, 180], [-90, -180], [90, -180]];
      let huecos = []; // Polígonos trabajados para “ventanas”
      let todosPoligonosTrabajados = [];

      // ================================
      // Resetear array global de selección por mes
      // ================================
      window.poligonosSeleccionadosPorMes = [];

      // ================================
      // Revisar todos los territorios
      // ================================
      window.todosLosTerritorios.forEach(territorio => {
        const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");

        territorio.eachLayer(pol => {
          let trabajadoEsteMes = false;

          // Revisar si el polígono tiene registro en el mes seleccionado o en cualquier mes
          (registros[pol._id] || []).forEach(reg => {
            const fecha = reg.split('| Fecha:')[1]?.trim();
            if (fecha) {
              const mesRegistro = fecha.slice(5, 7);
              if (mostrarTodos || mesRegistro === mes.padStart(2, '0')) {
                trabajadoEsteMes = true;
              }
            }
          });

          if (trabajadoEsteMes) {
            pol._selected = true;
            todosPoligonosTrabajados.push(pol);

            // Guardar en el array global
            window.poligonosSeleccionadosPorMes.push(pol._id);

            // Estilo resaltado para ventana
            pol.setStyle({
              color: "yellow",
              weight: 5,
              fillColor: "gray",
              fillOpacity: 0.7
            });

            // ================================
            // Crear icono de palomita
            // ================================
            const latlngs = pol.getLatLngs()[0];
            const coords = latlngs.map(ll => [ll.lng, ll.lat]);
            coords.push([coords[0][0], coords[0][1]]);
            const centroide = turf.centroid(turf.polygon([coords]));
            const cLat = centroide.geometry.coordinates[1];
            const cLng = centroide.geometry.coordinates[0];

            const marker = L.marker([cLat, cLng], {
              interactive: false,
              icon: L.divIcon({
                className: "indicador-nota",
                html: "✅",
                iconSize: [25, 25],
                iconAnchor: [12, 12]
              })
            }).addTo(map);

            window.indicadoresNotas.push(marker);

            // Guardar huecos para overlay gris
            if (pol.getLatLngs) huecos.push(pol.getLatLngs()[0].map(ll => [ll.lat, ll.lng]));
          } else {
            pol._selected = false;
            pol.setStyle(pol._originalStyle);
          }
        });
      });

      // ================================
      // Calcular porcentaje de avance del mes (SE ACTUALIZA SIEMPRE)
      // ================================
      const TOTAL_CUADRAS = 389; // Cambia aquí si el número total cambia
      const cantidadPalomitas = window.indicadoresNotas.length;
      const porcentaje = ((cantidadPalomitas / TOTAL_CUADRAS) * 100).toFixed(2);
      document.getElementById("porcentajeAvance").textContent = porcentaje + "%";


      // ================================
      // Crear overlay gris sobre todo el mapa excepto los polígonos trabajados
      // ================================
      if (huecos.length > 0) {
        window.overlayGris = L.polygon([mundo, ...huecos], {
          color: "#000",
          fillColor: "#000",
          fillOpacity: 0.6,
          stroke: false,
          interactive: false
        }).addTo(map);
      } else {
        if (window.overlayGris) map.removeLayer(window.overlayGris);
      }
    }














    // =======================================================================================================================================//



    /// ========================================================ENFOCAR TERRITORIO============================================================//

    // ================================
    // === BLOQUE: Enfocar un territorio ===
    // ================================
    function enfocarTerritorio(grupo) {
      territorioActivo = grupo;

      // ================================
      // Desactivar interacción de todos los territorios
      // ================================
      window.todosLosTerritorios.forEach(t => {
        t.eachLayer(pol => {
          // Quitar eventos previos
          pol.off('click');
          pol.off('contextmenu');

          // Restaurar estilo original
          if (pol._originalStyle) pol.setStyle(pol._originalStyle);

          // Limpiar referencias de popups activos
          pol._popupActivo = false;
        });
      });

      // ================================
      // Activar interacción solo en el territorio activo
      // ================================
      territorioActivo.eachLayer(pol => {
        pol._territorioId = grupo._id || "territorio";

        // Restaurar estilo según estado guardado (trabajado o no)
        pol.setStyle(pol._selected
          ? { color: "gray", fillColor: "gray", fillOpacity: 0.9 }
          : pol._originalStyle
        );

        // Registrar eventos para el polígono activo
        pol.off('click');
        pol.off('contextmenu');
        pol.on('click', function () {
          registrarCapitan(pol); // Abre popup para registrar capitán
        });
        pol.on('contextmenu', function (e) {
          mostrarMenu(e, pol, pol._notasPoligonos || {}, pol._territorioId); // Muestra menú contextual
        });
      });

      // ================================
      // Overlay gris sobre todo el mapa excepto el territorio activo
      // ================================
      if (overlayGris) map.removeLayer(overlayGris);

      var mundo = [[90, -180], [90, 180], [-90, 180], [-90, -180], [90, -180]];
      var huecos = [];
      territorioActivo.eachLayer(pol => {
        if (pol.getLatLngs) huecos.push(pol.getLatLngs()[0].map(ll => [ll.lat, ll.lng]));
      });

      overlayGris = L.polygon([mundo, ...huecos], {
        color: "#000",
        fillColor: "#000",
        fillOpacity: 0.6,
        stroke: false,
        interactive: false
      }).addTo(map);

      // ================================
      // Mostrar etiquetas de los polígonos
      // ================================
      mostrarEtiquetas();

      // ================================
      // Mostrar indicadores de notas (iconos) sobre el territorio activo
      // ================================
      mostrarIndicadoresNotas();
    }

    // =======================================================================================================================================//






    // ================================================================================================================================
    // === BLOQUE: Mostrar etiquetas de los polígonos ===
    // ================================================================================================================================
    function mostrarEtiquetas() {
      // ================================
      // Limpiar etiquetas anteriores del mapa
      // ================================
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      // ================================
      // Si no hay territorio activo, salir
      // ================================
      if (!territorioActivo) return;
      // ================================
      // Recorrer los polígonos del territorio activo
      // ================================
      territorioActivo.eachLayer(function (pol) {
        if (pol._label) {
          // Obtener coordenadas del polígono
          let latlngs = pol.getLatLngs()[0];
          let coords = latlngs.map(ll => [ll.lng, ll.lat]);
          coords.push([coords[0][0], coords[0][1]]); // cerrar el polígono
          // Calcular centroide con Turf
          let centroide = turf.centroid(turf.polygon([coords]));
          let cLat = centroide.geometry.coordinates[1];
          let cLng = centroide.geometry.coordinates[0];
          // Crear marcador tipo etiqueta en el centro del polígono
          let marker = L.marker([cLat, cLng], {
            interactive: false,
            icon: L.divIcon({
              className: "etiqueta-poligono",
              html: pol._label,
              iconSize: null,
              iconAnchor: [0, 0]
            })
          }).addTo(map);
          // Guardar la etiqueta para poder eliminarla después
          etiquetasActivas.push(marker);
        }
      });
    }
    // ================================================================================================================================//








    // ================================================================================================================================
    // === BLOQUE: Cambiar territorio desde el select ===
    // ================================================================================================================================
    function cambiarTerritorio() {
      // ================================
      // Cerrar cualquier popup abierto en el mapa
      // ================================
      map.closePopup();
      // ================================
      // Obtener el valor seleccionado del dropdown
      // ================================
      var selector = document.getElementById("selectorTerritorios");
      var valor = selector.value;
      selector.blur(); // quitar foco del selector
      // ================================
      // Ocultar menú contextual y limpiar etiquetas
      // ================================
      ocultarMenu();
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      // ================================
      // Caso "Área Grande": limpiar selección y volar al bounds inicial
      // ================================
      if (valor === "areaGrande") {
        selector.value = "";       // reiniciar selector
        territorioActivo = null;   // ningún territorio activo
        flyWithLoader(boundsIniciales); // mover mapa a vista general
        return;
      }
      // ================================
      // Caso territorios específicos: extraer número del id
      // ================================
      const match = valor.match(/^territorio(\d+)$/);
      if (match) {
        const num = match[1];
        const grupo = window["territorio" + num]; // obtener grupo de polígonos
        if (grupo && grupo.getLayers().length > 0) {
          // Volar al territorio y enfocar
          flyWithLoader(grupo.getBounds(), function () {
            enfocarTerritorio(grupo);
          });
        }
      }
    }

    // ================================================================================================================================//





    // ==========================================================================================================================
    // === BLOQUE: Botón Área Grande ===
    // ==========================================================================================================================
    const btnArea = document.getElementById("btnAreaGrande");
    let presionadoTimeout;

    // === Click izquierdo normal ===
    btnArea.addEventListener("click", function () {
      // ================================
      // Cerrar cualquier popup abierto
      // ================================
      map.closePopup();
      // ================================
      // Limpiar selector de territorios
      // ================================
      document.getElementById("selectorTerritorios").value = "";
      // ================================
      // Ocultar menú contextual y eliminar overlay gris
      // ================================
      ocultarMenu();
      if (overlayGris) {
        map.removeLayer(overlayGris);
        overlayGris = null;
      }
      // ================================
      // Eliminar todas las etiquetas del mapa
      // ================================
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      // ================================
      // Restaurar estilo de todos los polígonos y desmarcarlos
      // ================================
      window.todosLosTerritorios.forEach(territorio => {
        territorio.eachLayer(pol => {
          pol.setStyle(pol._originalStyle);
        });
      });
      // ================================
      // Limpiar territorio activo
      // ================================
      territorioActivo = null;
      // ================================
      // Volar a vista general de todo el mapa
      // ================================
      flyWithLoader(boundsIniciales);

      // ================================
      // Reiniciar custom select de territorios
      // ================================
      const customSelectTerr = document.getElementById("customSelectorTerritorios");
      const selectedTerr = customSelectTerr.querySelector(".selected");
      const selectorTerritorios = document.getElementById("selectorTerritorios");

      selectorTerritorios.value = "";                   // select oculto
      selectedTerr.textContent = "-- Selecciona un territorio --"; // custom select visible
      customSelectTerr.classList.remove("active");     // cerrar lista si estaba abierta

    });

    // === Click derecho (menú contextual) ===
    btnArea.addEventListener("contextmenu", function (e) {
      e.preventDefault(); // Evita que salga el menú del navegador
      const filtroMes = document.getElementById("filtroMes");
      const customSelect = document.getElementById("customFiltroMes");
      const selected = customSelect.querySelector(".selected");

      filtroMes.value = "inicio";   // select oculto
      selected.textContent = "Mes"; // custom select visible
      filtrarPorMes(); // Ejecuta la función de filtrado
      console.log("Clic derecho → Filtro establecido en 'Mes'");
    });

    // === Mantener presionado (funciona en PC y móvil) ===
    btnArea.addEventListener("mousedown", function () {
      presionadoTimeout = setTimeout(() => {
        const filtroMes = document.getElementById("filtroMes");
        const customSelect = document.getElementById("customFiltroMes");
        const selected = customSelect.querySelector(".selected");

        filtroMes.value = "inicio";
        selected.textContent = "Mes";
        filtrarPorMes();
        console.log("Pulsación larga → Filtro establecido en 'Mes'");
      }, 800); // 800 ms = ~0.8 s de mantener presionado
    });

    btnArea.addEventListener("mouseup", function () {
      clearTimeout(presionadoTimeout);
    });

    btnArea.addEventListener("mouseleave", function () {
      clearTimeout(presionadoTimeout);
    });

    btnArea.addEventListener("touchstart", function () {
      presionadoTimeout = setTimeout(() => {
        const filtroMes = document.getElementById("filtroMes");
        const customSelect = document.getElementById("customFiltroMes");
        const selected = customSelect.querySelector(".selected");

        filtroMes.value = "inicio";
        selected.textContent = "Mes";
        filtrarPorMes();
        console.log("Pulsación larga (móvil) → Filtro establecido en 'Mes'");
      }, 800);
    });

    btnArea.addEventListener("touchend", function () {
      clearTimeout(presionadoTimeout);
    });
    // ================================================================================================================================//









    // ================================================================================================================================
    // === BLOQUE: Inicializar todos los territorios automáticamente ===
    // ================================================================================================================================

    // Lista de todos los datos de los territorios
    const listaTerritorios = [
      datosTerritorio1, datosTerritorio2, datosTerritorio3, /* ... */ datosTerritorio84
    ];
    // Array global donde guardaremos todos los grupos de polígonos
    window.todosLosTerritorios = [];
    // Crear cada territorio y añadirlo al mapa
    listaTerritorios.forEach(datosTerritorio => {
      // Crear territorio con polígonos y demás datos
      const territorioData = crearTerritorio(datosTerritorio);
      const grupo = territorioData.grupo;
      // Guardar grupo en array global
      window.todosLosTerritorios.push(grupo);
      // Tomar un polígono de referencia para colocar marcador
      const polFijo = datosTerritorio.poligonos[1] || datosTerritorio.poligonos[0];
      const centro = L.polygon(polFijo.coords).getBounds().getCenter();
      // Crear marcador con número del territorio
      const marcador = L.marker(centro, {
        icon: L.divIcon({
          className: "etiquetaTerritorio",
          html: `<b>${datosTerritorio.numeroTerritorio}</b>`,
          iconSize: [20, 20]
        })
      }).addTo(map);
      // Guardar referencia del marcador dentro del grupo
      grupo._marcadorTerritorio = marcador;
    });
    // ================================================================================================================================//





    // ================================
    // === BLOQUE: Filtrar al elegir mes (PC + móviles) ===
    // ================================

    // Obtener el selector de mes
    const filtroMes = document.getElementById("filtroMes");

    if (filtroMes) {
      // Eventos normales
      filtroMes.addEventListener("input", filtrarPorMes);
      filtroMes.addEventListener("change", filtrarPorMes);

      // === CLICK DERECHO (PC) ===
      filtroMes.addEventListener("contextmenu", function (e) {
        e.preventDefault(); // Evita que aparezca el menú del navegador
        filtroMes.value = "inicio"; // Selecciona la opción "Mes"
        filtrarPorMes();
      });

      // === DEJAR PRESIONADO (MÓVIL) ===
      let pressTimer;
      filtroMes.addEventListener("touchstart", function (e) {
        pressTimer = setTimeout(() => {
          filtroMes.value = "inicio"; // Selecciona la opción "Mes"
          filtrarPorMes();
        }, 800); // 800 ms = dejar presionado
      });

      filtroMes.addEventListener("touchend", function (e) {
        clearTimeout(pressTimer); // Cancela si no se mantiene presionado
      });
    }

    // ================================================================================================================================//








    // ================================
    // Función para generar HTML de registros
    // ================================
    function generarHtml() {
      let html = `<h2 style="text-align:center; color:#333;">🗺️ Territorios terminados - ${mesNombre}</h2><hr style="margin-bottom:15px;">`;
      let hayRegistros = false;
      const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
      let registrosFiltrados = []; // Array para exportar Excel
      // Revisar todos los territorios
      window.todosLosTerritorios.forEach((territorio, tIndex) => {
        let territorioHtml = "";
        territorio.eachLayer(pol => {
          if (!pol._selected) return; // Solo polígonos marcados
          const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");
          (registros[pol._id] || []).forEach(reg => {
            const partes = reg.split('| Fecha:');
            const capitan = partes[0].replace("Capitán:", "").replace("Trabajado por:", "").trim();
            const fecha = partes[1]?.trim();
            if (!fecha) return;
            // Extraer mes del registro
            let mesRegistro = '';
            if (fecha.includes('-')) mesRegistro = fecha.split('-')[1];
            else if (fecha.includes('/')) mesRegistro = fecha.split('/')[1];
            else if (fecha.length >= 5) mesRegistro = fecha.slice(3, 5);
            // Solo registros del mes seleccionado
            if (mesRegistro === mes.padStart(2, '0')) {
              if (!territorioHtml)
                territorioHtml += `<h3 style="margin-top:15px; color:#444;">📍 Territorio ${tIndex + 1}</h3>`;
              // Limpiar nombre de la cuadra
              const cuadraLimpia = pol._id.replace(/^.*?Cuadra(\d+).*$/i, "$1").trim();
              // Formatear fecha
              const partesFecha = fecha.split("-");
              const dia = partesFecha[0].padStart(2, "0");
              const mesNum = parseInt(partesFecha[1], 10);
              const anio = partesFecha[2];
              const mesTexto = mesesCortos[mesNum - 1] || "???";
              const fechaFormateada = `${dia}-${mesTexto}-${anio}`;
              // HTML de cada registro
              territorioHtml += `<p class="registroItem" style="background:#f8f8f8; padding:8px 10px; border-radius:6px; margin:5px 0; color:#000;">
              <strong>Cuadra ${cuadraLimpia}</strong> | Trabajado por: <strong style="color:red;">${capitan}</strong> | Fecha: <strong style="color:red;">${fechaFormateada}</strong>
            </p>`;
              // Guardar en array para Excel
              registrosFiltrados.push([`Territorio ${tIndex + 1} - Cuadra ${cuadraLimpia}`, capitan, fechaFormateada]);
              hayRegistros = true;
            }
          });
        });
        if (territorioHtml) html += territorioHtml;
      });
      if (!hayRegistros) html += "<p>No se encontraron registros para este mes.</p>";
      // Botón de exportación
      html += `<button id="btnExportarExcelPopup" style="display:block; margin:20px auto 0; padding:12px 18px; background:#2196f3; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
      📥 Exportar datos a Excel
    </button>`;
      return { html, registrosFiltrados };
    }
    const { html, registrosFiltrados } = generarHtml();




    // ================================
    // Crear modal para mostrar registros
    // ================================
    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = 0;
    modal.style.left = 0;
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.backgroundColor = "rgba(0,0,0,0.6)";
    modal.style.zIndex = 9999;
    modal.style.overflowY = "auto";
    modal.style.backdropFilter = "blur(3px)";
    modal.innerHTML = `
    <div id="contenidoModal" style="background:#fff; padding:25px; margin:60px auto; width:85%; max-width:750px; border-radius:12px; position:relative; box-shadow:0 5px 20px rgba(0,0,0,0.3); transition: all 0.3s ease;">
      <button id="cerrarModal" style="position:absolute; top:10px; right:10px; font-size:20px; background:none; border:none; cursor:pointer;">✖</button>
      ${html}
    </div>
  `;
    document.body.appendChild(modal);
    // Cerrar modal
    document.getElementById("cerrarModal").addEventListener("click", () => {
      document.body.removeChild(modal);
    });





  </script>




  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // ====================
      // COPIA DE SEGURIDAD
      // ====================
      function hacerCopiaSeguridad() {
        const popup = document.createElement('div');
        popup.style.position = 'fixed';
        popup.style.top = '50%';
        popup.style.left = '50%';
        popup.style.transform = 'translate(-50%, -50%)';
        popup.style.backgroundColor = '#fff';
        popup.style.padding = '20px';
        popup.style.borderRadius = '10px';
        popup.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
        popup.style.zIndex = 9999;
        popup.innerHTML = `
      <p>Registrar copia de seguridad</p>
      <label>Nombre: <input type="text" id="backupName" placeholder="Nombre de copia de seguridad"></label><br><br>
      <label>Fecha: <input type="date" id="backupDate"></label><br><br>
      <button id="confirmBackup" style="padding:10px 15px; background:#28a745; color:#fff; border:none; border-radius:5px; cursor:pointer;">Guardar</button>
      <button id="cancelBackup" style="padding:10px 15px; background:#ccc; color:#000; border:none; border-radius:5px; cursor:pointer;">Cancelar</button>
    `;
        document.body.appendChild(popup);

        document.getElementById('cancelBackup').addEventListener('click', () => {
          document.body.removeChild(popup);
        });

        document.getElementById('confirmBackup').addEventListener('click', () => {
          const nombre = document.getElementById('backupName').value.trim() || 'Copia';
          const fechaInput = document.getElementById('backupDate').value;
          let fecha = new Date();
          if (fechaInput) fecha = new Date(fechaInput);

          const nombreArchivo = `${nombre} ${fecha.getDate()}-${fecha.getMonth() + 1}-${fecha.getFullYear()}.json`;
          const data = JSON.stringify(localStorage, null, 2);
          const blob = new Blob([data], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = nombreArchivo;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          document.body.removeChild(popup);

          const popup2 = document.createElement('div');
          popup2.style.position = 'fixed';
          popup2.style.top = '50%';
          popup2.style.left = '50%';
          popup2.style.transform = 'translate(-50%, -50%)';
          popup2.style.backgroundColor = '#fff';
          popup2.style.padding = '20px';
          popup2.style.borderRadius = '10px';
          popup2.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
          popup2.style.zIndex = 9999;
          popup2.innerHTML = `
        <p>Copia de seguridad "${nombreArchivo}" descargada ✅</p>
        <button id="cerrarPopup2" style="padding:10px 15px; background:#ccc; color:#000; border:none; border-radius:5px; cursor:pointer;">Cerrar</button>
      `;
          document.body.appendChild(popup2);
          document.getElementById('cerrarPopup2').addEventListener('click', () => document.body.removeChild(popup2));
        });
      }

      // ====================
      // RESTAURAR COPIA
      // ====================
      function restaurarCopia() {
        const restoreFile = document.createElement('input');
        restoreFile.type = 'file';
        restoreFile.accept = '.json';
        restoreFile.style.display = 'none';
        document.body.appendChild(restoreFile);

        restoreFile.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (event) {
            try {
              const data = JSON.parse(event.target.result);
              localStorage.clear();
              for (const key in data) localStorage.setItem(key, data[key]);
              alert('Copia de seguridad restaurada ✅');
              location.reload();
            } catch (err) {
              alert('Error al restaurar el archivo. Asegúrate de que sea la copia correcta.');
            }
          };
          reader.readAsText(file);
        });

        restoreFile.click();
        document.body.removeChild(restoreFile);
      }

      // ====================
      // BOTÓN UBICACIÓN
      // ====================
      let marcadorUbicacion = null;
      let seguimientoActivo = false;
      let watchId = null;

      function activarUbicacion() {
        const btnAreaGrande = document.getElementById("btnAreaGrande");
        const menuPanel = document.getElementById('menu-panel');

        if (!navigator.geolocation) {
          alert("Tu navegador no soporta geolocalización. Bienvenido al pasado.");
          return;
        }

        // Si ya está activo, detenerlo
        if (seguimientoActivo) {
          navigator.geolocation.clearWatch(watchId);
          seguimientoActivo = false;
          if (marcadorUbicacion) {
            map.removeLayer(marcadorUbicacion);
            marcadorUbicacion = null;
          }
          if (btnAreaGrande) btnAreaGrande.click();

          // Cerrar menú hamburguesa
          if (menuPanel.classList.contains('show')) {
            menuPanel.classList.remove('show');
          }
          return;
        }

        // Loader mientras obtiene ubicación
        const loader = document.createElement('div');
        loader.innerHTML = `
    <div style="
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    ">
      <div style="
        width: 60px; height: 60px;
        border: 6px solid #fff;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      "></div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
        document.body.appendChild(loader);

        seguimientoActivo = true;

        watchId = navigator.geolocation.watchPosition(
          function (pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            if (marcadorUbicacion) marcadorUbicacion.setLatLng([lat, lon]);
            else marcadorUbicacion = L.marker([lat, lon]).addTo(map).openPopup();
            map.setView([lat, lon], 17);
            document.body.removeChild(loader);
          },
          function (err) {
            alert("Error al obtener ubicación: " + err.message);
            seguimientoActivo = false;
            document.body.removeChild(loader);
          },
          { enableHighAccuracy: true }
        );
      }


      // ====================
      // MENU HAMBURGUESA
      // ====================
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const menuPanel = document.getElementById('menu-panel');
      const backupBtnMenu = document.getElementById('btnCopiaSeguridad');
      const restoreBtnMenu = document.getElementById('btnRestaurar');
      const btnUbicacionMenu = document.getElementById('btnUbicacion');

      // Toggle del menú
      hamburgerBtn.addEventListener('click', (e) => {
        menuPanel.classList.toggle('show');
        e.stopPropagation(); // evita que el click se propague y cierre el menú inmediatamente
      });

      // Función para cerrar el menú
      function cerrarMenu() {
        if (menuPanel.classList.contains('show')) {
          menuPanel.classList.remove('show');
        }
      }

      // Conectar botones a funciones y cerrar menú
      backupBtnMenu.addEventListener('click', (e) => {
        cerrarMenu();
        hacerCopiaSeguridad();
        e.stopPropagation();
      });

      restoreBtnMenu.addEventListener('click', (e) => {
        cerrarMenu();
        restaurarCopia();
        e.stopPropagation();
      });

      btnUbicacionMenu.addEventListener('click', (e) => {
        cerrarMenu();
        activarUbicacion();
        e.stopPropagation();
      });

      // Cerrar menú si se hace click en cualquier otra parte de la página
      document.addEventListener('click', (e) => {
        // Solo cerrar si el click no fue dentro del menú ni en el botón hamburguesa
        if (!menuPanel.contains(e.target) && e.target !== hamburgerBtn) {
          cerrarMenu();
        }
      });
    });









    // ====================
    // FUNCION GENERAL PARA LOS SELECTS PERSONALIZADOS
    // ====================

    function initCustomSelect(customId, originalId, callback) {
      const customSelect = document.getElementById(customId);
      if (!customSelect) return;

      const selected = customSelect.querySelector(".selected");
      const options = customSelect.querySelectorAll(".options li");
      const originalSelect = document.getElementById(originalId);

      // Abrir/cerrar el select al hacer click
      selected.addEventListener("click", (e) => {
        e.stopPropagation();
        closeAllCustomSelects(customSelect);
        customSelect.classList.toggle("active");
      });

      // Selección de opción
      options.forEach(opt => {
        opt.addEventListener("click", (e) => {
          e.stopPropagation();
          const value = opt.dataset.value;
          selected.textContent = opt.textContent;
          originalSelect.value = value;
          customSelect.classList.remove("active");
          callback(value);
        });
      });

      // Evitar rebote de scroll en móviles
      const optionsContainer = customSelect.querySelector(".options");
      optionsContainer.addEventListener("touchmove", (e) => {
        e.stopPropagation();
      }, { passive: false });
    }

    // ====================
    // FUNCION PARA CERRAR TODOS LOS SELECTS
    // ====================

    function closeAllCustomSelects(exception = null) {
      document.querySelectorAll(".custom-select").forEach(sel => {
        if (sel !== exception) sel.classList.remove("active");
      });
    }

    // ====================
    // CERRAR AL HACER CLICK FUERA
    // ====================

    // Cerramos solo si el click NO ocurrió dentro de ningún custom select
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".custom-select")) {
        closeAllCustomSelects();
      }
    });
    document.addEventListener("touchstart", (e) => {
      if (!e.target.closest(".custom-select")) {
        closeAllCustomSelects();
      }
    });

    // ====================
    // INICIALIZACIÓN
    // ====================

    initCustomSelect("customFiltroMes", "filtroMes", filtrarPorMes);
    initCustomSelect("customSelectorTerritorios", "selectorTerritorios", cambiarTerritorio);




    // ===============================
    // === MOSTRAR UBICACIÓN MANUALMENTE + ACTIVAR ÁREA GRANDE ===
    // ===============================

    let marcadorUbicacion = null;
    let seguimientoActivo = false;
    let watchId = null;

    function activarUbicacion() {
      const btnUbicacion = document.getElementById("btnUbicacion");
      const btnAreaGrande = document.getElementById("btnAreaGrande"); // tu botón de área grande

      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalización. Bienvenido al pasado.");
        return;
      }

      if (seguimientoActivo) {
        // Si ya está activo, desactiva ubicación
        navigator.geolocation.clearWatch(watchId);
        seguimientoActivo = false;
        btnUbicacion.innerText = "📍";
        if (marcadorUbicacion) {
          map.removeLayer(marcadorUbicacion);
          marcadorUbicacion = null;
        }

        // Activar automáticamente el botón de área grande
        if (btnAreaGrande) btnAreaGrande.click();

        return;
      }

      // Activar seguimiento de ubicación
      seguimientoActivo = true;
      btnUbicacion.innerText = "❌";

      watchId = navigator.geolocation.watchPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          if (marcadorUbicacion) {
            marcadorUbicacion.setLatLng([lat, lon]);
          } else {
            marcadorUbicacion = L.marker([lat, lon]).addTo(map).openPopup();
          }

          map.setView([lat, lon], 17);
        },
        function (err) {
          alert("Error al obtener ubicación: " + err.message);
          seguimientoActivo = false;
        },
        { enableHighAccuracy: true }
      );
    }

    // Conectar el botón con la función
    document.getElementById("btnUbicacion").addEventListener("click", activarUbicacion);
















    // =========================================================================================================================================
    // === Botón Territorios Terminados con notas integradas (bloque corregido y funcional) ===
    // =========================================================================================================================================
    document.getElementById("btnTerritoriosTerminados").addEventListener("click", function () {
      const mes = document.getElementById('filtroMes').value;
      if (!mes) { alert("Selecciona primero un mes o 'Todos los meses' para mostrar los territorios terminados."); return; }
      const mostrarTodos = (mes === "todos");

      // ---------- Formateo de fecha reutilizable ----------
      function formatearFechaParaMostrar(fechaRaw) {
        if (!fechaRaw) return "???";
        const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
        try {
          if (fechaRaw.includes("/")) {
            const p = fechaRaw.split("/");
            return `${p[2]}-${mesesCortos[parseInt(p[1], 10) - 1] || "???"}-${String(p[0]).padStart(2, "0")}`;
          }
          if (fechaRaw.includes("-")) {
            const p = fechaRaw.split("-");
            if (p[0].length === 4) {
              const año = p[0], mesStr = p[1], dia = String(p[2]).padStart(2, "0");
              const mesNum = isNaN(mesStr) ? (mesesCortos.indexOf(mesStr.toLowerCase()) + 1) : parseInt(mesStr, 10);
              return `${año}-${(mesesCortos[mesNum - 1] || "??")}-${dia}`;
            } else {
              const dia = String(p[0]).padStart(2, "0"), mesStr = p[1], año = p[2];
              const mesNum = isNaN(mesStr) ? (mesesCortos.indexOf(mesStr.toLowerCase()) + 1) : parseInt(mesStr, 10);
              return `${año}-${(mesesCortos[mesNum - 1] || "??")}-${dia}`;
            }
          }
          return fechaRaw;
        } catch { return fechaRaw; }
      }

      // ---------- Genera HTML del modal ----------
      function generarHtmlModal() {
        return `
      <div style="padding:20px;max-width:900px;margin:30px auto;background:#fff;border-radius:12px;position:relative;">
        <button id="cerrarModalTT" style="position:absolute;right:12px;top:12px;border:none;background:none;font-size:20px;cursor:pointer;">✖</button>
        <h2 style="text-align:center;margin-top:0;">🗺️ Territorios terminados - ${mostrarTodos ? "Todos los meses" : (new Date(2025, parseInt(mes) - 1).toLocaleString('es-MX', { month: 'long' }))}</h2>
        <hr style="margin-bottom:12px;" />
        <div id="listaRegistros" style="max-height:60vh;overflow:auto;padding-right:8px;"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap;">
          <button id="borrarRegistros" style="padding:10px 16px;background:#e53935;color:#fff;border:none;border-radius:8px;cursor:pointer;">🗑️ Borrar registros del mes</button>
          <button id="btnExportarExcelPopup" style="padding:10px 16px;background:#43a047;color:#fff;border:none;border-radius:8px;cursor:pointer;">📤 Exportar a Excel</button>
          <button id="btnCerrarModal" style="padding:10px 16px;background:#777;color:#fff;border:none;border-radius:8px;cursor:pointer;">Cerrar</button>
        </div>
      </div>`;
      }

      // ---------- Crear modal ----------
      const overlay = document.createElement("div");
      overlay.id = "modalTerritoriosTerminados";
      overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:flex-start;justify-content:center;overflow:auto;padding:30px 12px;";
      overlay.innerHTML = generarHtmlModal();
      document.body.appendChild(overlay);
      const contLista = overlay.querySelector("#listaRegistros");

      // ---------- Cargar registros ----------
      function cargarRegistrosEnLista() {
        contLista.innerHTML = "";
        let hay = false;
        window.todosLosTerritorios.forEach((territorio, tIndex) => {
          let registrosHTML = "";
          territorio.eachLayer(pol => {
            const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");
            (registros[pol._id] || []).forEach((reg, idx) => {
              const partes = reg.split('| Fecha:');
              const cap = (partes[0] || "").replace("Capitán:", "").replace("Trabajado por:", "").trim();
              const resto = (partes[1] || "").trim();
              const fechaRaw = resto.split('| Comentario:')[0]?.trim() || "";
              const nota = resto.split('| Comentario:')[1]?.trim() || "";
              if (!fechaRaw) return;
              let mesReg = "";
              if (fechaRaw.includes('-')) mesReg = fechaRaw.split('-')[1];
              else if (fechaRaw.includes('/')) mesReg = fechaRaw.split('/')[1];
              if (mostrarTodos || mesReg === String(mes).padStart(2, '0')) {
                const cuadra = pol._id.replace(/^.*?Cuadra(\d+).*$/i, "$1");
                const fechaFmt = formatearFechaParaMostrar(fechaRaw);
                registrosHTML += `
              <div class="registroItem" data-territorio="${territorio._id}" data-pol="${pol._id}" data-index="${idx}" style="background:#f8f8f8;padding:10px;border-radius:8px;margin:8px 0;">
                <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:space-between;">
                  <div style="flex-grow:1;">
                    <strong>Cuadra ${cuadra}</strong> |
                    Trabajado por: <span class="nombreCapitan" style="font-weight:bold;color:red;">${cap}</span> |
                    Fecha: <span class="fechaRegistro" style="font-weight:bold;color:red;">${fechaFmt}</span>
                    ${nota ? `<br><small>Nota: ${nota}</small>` : ""}
                  </div>
                  <div style="display:flex;gap:4px;">
                    <button class="btnEditarInline" style="padding:4px;border:none;border-radius:4px;background:#1976d2;color:#fff;cursor:pointer;">✏️</button>
                    <button class="btnEliminar" style="padding:4px;border:none;border-radius:4px;background:#e53935;color:#fff;cursor:pointer;">🗑️</button>
                    
                  </div>
                </div>
              </div>`;
                hay = true;
              }
            });
          });
          if (registrosHTML) {
            // Buscar si hay comentarios guardados en este territorio
            const comentariosGuardados = JSON.parse(localStorage.getItem(`${territorio._id}_comentario`) || "{}");
            const hayComentario = Object.keys(comentariosGuardados).length > 0;

            // Crear encabezado con icono minimalista (🗒 reemplazado por ícono estilo bloc)
            let headerHTML = `
    <div class="territorioHeader" style="background:#eee;padding:10px;cursor:pointer;font-weight:bold;display:flex;align-items:center;justify-content:space-between;">
      <span>📍 Territorio ${tIndex + 1}</span>
      ${hayComentario ? `<span class="iconoNota" style="color:#555;font-size:16px;cursor:pointer;" title="Ver notas">🗒</span>` : ""}
    </div>
  `;

            // Insertar acordeón con el encabezado y contenido
            contLista.insertAdjacentHTML('beforeend', `
    <div class="territorioAccordion" style="border:1px solid #ccc;border-radius:8px;margin:6px 0;">
      ${headerHTML}
      <div class="territorioContent" style="display:none;padding:10px;">${registrosHTML}</div>
    </div>
  `);

            // === Evento al hacer clic en el ícono de nota ===
            if (hayComentario) {
              const ultimoAccordion = contLista.lastElementChild;
              const icono = ultimoAccordion.querySelector(".iconoNota");
              icono.addEventListener("click", (e) => {
                e.stopPropagation();

                // Construir el contenido de las notas con clases correctas
                let contenidoNotas = "";
                for (const [capitan, comentario] of Object.entries(comentariosGuardados)) {
                  contenidoNotas += `
        <div class="notaItem" style="border-bottom:1px solid #ddd;padding:6px 0;">
          <p class="notaTexto" style="margin:0 0 4px 0;"><strong>${capitan}</strong>: ${comentario}</p>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btnEditarNota" data-capitan="${capitan}" style="padding:4px 8px;border:none;border-radius:4px;background:#1976d2;color:#fff;cursor:pointer;">Editar</button>
            <button class="btnEliminarNota" data-capitan="${capitan}" style="padding:4px 8px;border:none;border-radius:4px;background:#e53935;color:#fff;cursor:pointer;">Eliminar</button>
          </div>
        </div>`;
                }

                // Crear popup elegante
                const popup = document.createElement("div");
                popup.style.cssText = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.4);
      display:flex;align-items:center;justify-content:center;
      z-index:10000;animation:fadeInBg 0.2s ease;
    `;
                popup.innerHTML = `
      <div style="
          background:#fff;
          border-radius:12px;
          padding:18px;
          max-width:380px;
          width:85%;
          box-shadow:0 4px 16px rgba(0,0,0,0.25);
          font-family:Arial,sans-serif;
          position:relative;
          animation:fadeIn 0.25s ease-in-out;
      ">
          <button id="cerrarPopupNota" style="
              position:absolute;top:8px;right:8px;
              border:none;background:none;font-size:18px;
              color:#666;cursor:pointer;
          ">✖</button>
          <h3 style="text-align:center;margin-bottom:10px;">Notas del Territorio ${tIndex + 1}</h3>
          <div id="contenedorNotas" style="max-height:240px;overflow-y:auto;color:#374151;font-size:15px;">
            ${contenidoNotas}
          </div>
      </div>
    `;
                document.body.appendChild(popup);

                // Cerrar popup
                popup.querySelector("#cerrarPopupNota").addEventListener("click", () => document.body.removeChild(popup));

                // === Eventos de editar y eliminar notas ===
                popup.querySelectorAll(".notaItem").forEach(item => {
                  const btnEditar = item.querySelector(".btnEditarNota");
                  const btnEliminar = item.querySelector(".btnEliminarNota");
                  const notaDiv = item.querySelector(".notaTexto");
                  const capitan = btnEditar.dataset.capitan;

                  let editing = false;
                  let textoOriginal = "";

                  btnEditar.addEventListener("click", () => {
                    if (!editing) {
                      editing = true;
                      textoOriginal = notaDiv.textContent.trim();
                      notaDiv.contentEditable = "true";
                      notaDiv.style.background = "#fff8dc";
                      notaDiv.focus();
                      btnEditar.textContent = "💾 Guardar";
                      btnEliminar.textContent = "✖ Cancelar";
                    } else {
                      const nuevoTexto = notaDiv.textContent.trim();
                      comentariosGuardados[capitan] = nuevoTexto;
                      localStorage.setItem(`${territorio._id}_comentario`, JSON.stringify(comentariosGuardados));
                      notaDiv.contentEditable = "false";
                      notaDiv.style.background = "transparent";
                      btnEditar.textContent = "Editar";
                      btnEliminar.textContent = "Eliminar";
                      editing = false;
                      alert("Nota actualizada correctamente.");
                    }
                  });

                  btnEliminar.addEventListener("click", () => {
                    if (editing) {
                      // Cancelar edición
                      notaDiv.textContent = textoOriginal;
                      notaDiv.contentEditable = "false";
                      notaDiv.style.background = "transparent";
                      btnEditar.textContent = "Editar";
                      btnEliminar.textContent = "Eliminar";
                      editing = false;
                    } else {
                      // Eliminar nota
                      if (confirm(`¿Eliminar nota de ${capitan}?`)) {
                        delete comentariosGuardados[capitan];
                        localStorage.setItem(`${territorio._id}_comentario`, JSON.stringify(comentariosGuardados));
                        item.remove();
                      }
                    }
                  });
                });
              });
            }
          }

        });
        if (!hay) contLista.innerHTML = `<p style="color:#666;text-align:center;">No se encontraron registros para este mes.</p>`;
        contLista.querySelectorAll('.territorioHeader').forEach(h => {
          h.addEventListener('click', () => {
            const c = h.nextElementSibling;
            c.style.display = c.style.display === 'none' ? 'block' : 'none';
          });
        });
      }
      cargarRegistrosEnLista();

      // ---------- Delegación de eventos ----------
      overlay.addEventListener('click', e => {
        const t = e.target;
        if (t.id === 'cerrarModalTT' || t.id === 'btnCerrarModal') { overlay.remove(); return; }

        if (t.classList.contains('btnEditarInline')) {
          const item = t.closest('.registroItem');
          const territorioId = item.dataset.territorio, polId = item.dataset.pol, index = parseInt(item.dataset.index, 10);
          const registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");
          const texto = registros[polId]?.[index] || "";
          const partes = texto.split('| Fecha:');
          const cap = (partes[0] || "").replace("Capitán:", "").trim();
          const resto = (partes[1] || "").trim();
          const fechaRaw = resto.split('| Comentario:')[0]?.trim() || "";
          const nota = resto.split('| Comentario:')[1]?.trim() || "";
          const div = item.querySelector('div');
          div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:6px;flex-grow:1;">
          <input class="inputEditNombre" style="padding:6px;border-radius:6px;border:1px solid #ccc;" value="${cap}" />
          <input class="inputEditFecha" type="date" style="padding:6px;border-radius:6px;border:1px solid #ccc;" />
          <small>Nota: ${nota || ""}</small>
        </div>
        <div style="display:flex;gap:4px;">
          <button class="btnGuardarEd" style="padding:4px;border:none;border-radius:4px;background:#43a047;color:#fff;cursor:pointer;">💾</button>
          <button class="btnCancelarEd" style="padding:4px;border:none;border-radius:4px;background:#999;color:#fff;cursor:pointer;">✖</button>
        </div>`;
          const inputFecha = item.querySelector('.inputEditFecha');
          try {
            if (fechaRaw.includes('-')) {
              const p = fechaRaw.split('-');
              if (p[0].length === 4) {
                const meses = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
                let m = isNaN(p[1]) ? (meses.indexOf(p[1].toLowerCase()) + 1) : parseInt(p[1], 10);
                inputFecha.value = `${p[0]}-${String(m).padStart(2, '0')}-${String(p[2]).padStart(2, '0')}`;
              }
            }
          } catch { }
          return;
        }

        if (t.classList.contains('btnGuardarEd')) {
          const item = t.closest('.registroItem');
          const territorioId = item.dataset.territorio, polId = item.dataset.pol, index = parseInt(item.dataset.index, 10);
          const registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");
          const nombre = item.querySelector('.inputEditNombre').value.trim();
          const fecha = item.querySelector('.inputEditFecha').value;
          if (!nombre) { alert("Nombre vacío"); return; }
          const meses = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
          const fSplit = fecha.split('-');
          const fechaFmt = `${fSplit[0]}-${meses[parseInt(fSplit[1], 10) - 1]}-${fSplit[2]}`;
          const textoPrev = registros[polId][index];
          const notaPrev = textoPrev.split('| Comentario:')[1]?.trim() || "";
          registros[polId][index] = `Capitán: ${nombre} | Fecha: ${fechaFmt}${notaPrev ? " | Comentario: " + notaPrev : ""}`;
          localStorage.setItem(territorioId + "_capitanes", JSON.stringify(registros));
          cargarRegistrosEnLista();
          return;
        }

        if (t.classList.contains('btnCancelarEd')) { cargarRegistrosEnLista(); return; }

        if (t.classList.contains('btnEliminar')) {
          const item = t.closest('.registroItem');
          if (!confirm("¿Eliminar este registro?")) return;
          const territorioId = item.dataset.territorio, polId = item.dataset.pol, index = parseInt(item.dataset.index, 10);
          const registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");
          registros[polId].splice(index, 1);
          localStorage.setItem(territorioId + "_capitanes", JSON.stringify(registros));
          item.remove();
          return;
        }
        if (t.classList.contains('btnNota')) {
          const item = t.closest('.registroItem');
          const territorioId = item.dataset.territorio;
          const polId = item.dataset.pol;
          const index = parseInt(item.dataset.index, 10);
          const registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");
          const texto = registros[polId]?.[index] || "";
          const notaMatch = texto.match(/\|\s*Comentario\s*:\s*(.*)$/);
          const nota = notaMatch ? notaMatch[1].trim() : "Sin nota";

          // Crear popup elegante
          const popup = document.createElement("div");
          popup.style.cssText = `
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.4);
        display:flex;align-items:center;justify-content:center;
        z-index:10000;animation:fadeInBg 0.2s ease;
    `;
          popup.innerHTML = `
        <div style="
            background:#fff;
            border-radius:12px;
            padding:18px;
            max-width:380px;
            width:85%;
            box-shadow:0 4px 16px rgba(0,0,0,0.25);
            font-family:Arial,sans-serif;
            position:relative;
            animation:fadeIn 0.25s ease-in-out;
        ">
            <button id="cerrarPopupNotaIndividual" style="
                position:absolute;top:8px;right:8px;
                border:none;background:none;font-size:18px;
                color:#666;cursor:pointer;
            ">✖</button>
            <h3 style="text-align:center;margin-bottom:10px;">Nota</h3>
            <p style="font-size:15px;color:#374151;">${nota}</p>
        </div>
    `;
          document.body.appendChild(popup);

          popup.querySelector("#cerrarPopupNotaIndividual")
            .addEventListener("click", () => document.body.removeChild(popup));
        }
      });
    });











    // ===============================
    // === BOTON REGISTRAR CAPITAN ===
    // ===============================

    document.getElementById("registrarTerritorioBtn").addEventListener("click", () => {
      const modal = document.createElement('div');
      modal.style.cssText = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    display:flex;align-items:center;justify-content:center;
    z-index:9999;font-family:Arial, sans-serif;
    animation:fadeInBg 0.3s ease forwards;
  `;

      modal.innerHTML = `
    <div id="modalContenido" style="
  background:#f9fafb;
  border-radius:16px;
  width:90%;
  max-width:480px;
  padding:24px;
  box-shadow:0 4px 20px rgba(0,0,0,0.25);
  position:relative;
  animation:fadeIn 0.25s ease-in-out;
  display:flex;
  flex-direction:column;
  max-height:90vh;
">
  <button id="cerrarModalTerritorio" style="
      position:absolute;top:12px;right:12px;
      border:none;background:none;
      font-size:22px;cursor:pointer;color:#888;
      transition:color 0.2s;
    ">✖</button>

  <h2 style="text-align:center;margin-bottom:18px;color:#111827;">Registrar Territorio</h2>

  <div style="overflow-y:auto;flex:1;padding-right:4px;">
    <label style="display:block;margin-bottom:12px;color:#374151;font-weight:600;">
      Nombre Capitán
      <input type="text" id="capitanTerritorio" style="
          width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:4px;font-size:15px;
        " />
    </label>

    <label style="display:block;margin-bottom:12px;color:#374151;font-weight:600;">
      Fecha
      <input type="date" id="fechaTerritorio" style="
          width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:4px;font-size:15px;
        " />
    </label>

    <label style="display:block;margin-bottom:12px;color:#374151;font-weight:600;">
      Territorio
      <div id="dropdownTerritorio" style="position:relative;margin-top:4px;">
        <div id="selectedTerritorio" style="
            padding:10px 12px;
            border:1px solid #d1d5db;
            border-radius:8px;
            background:#f0f0f0;
            cursor:pointer;
            font-size:15px;
          ">Seleccionar Territorio</div>
        <div id="listaTerritorios" style="
            position:absolute;top:100%;left:0;width:100%;max-height:180px;
            overflow-y:auto;background:#fff;border:1px solid #d1d5db;border-radius:8px;
            box-shadow:0 3px 8px rgba(0,0,0,0.15);display:none;z-index:1000;
          "></div>
      </div>
    </label>

    <div id="cuadrasCheckbox" style="
  margin-top:10px;
  max-height:140px;
  overflow-y:auto;
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:10px;
  background:#fff;
"></div>

<label style="display:block;margin-top:12px;color:#374151;font-weight:600;">
  Comentario (opcional)
  <input type="text" id="comentarioTerritorio" style="
    width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:4px;font-size:15px;
  " />
</label>

<button id="agregarTerritorio" style="
  margin-top:8px;
  padding:10px 16px;
  font-size:15px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  background:black;
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  box-shadow:0 8px 32px rgba(0,0,0,0.2);
  color:#fff;
  font-weight:600;
  transition:transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
">
  Agregar ✅
</button>

<div id="listaAgregados" style="
  margin-top:10px;
  max-height:150px;
  overflow-y:auto;
  border:1px solid #d1d5db;
  border-radius:8px;
  padding:8px;
  background:#fff;
"></div>


  <!-- BOTÓN FIJO -->
  <div style="
    position:sticky;
    bottom:0;
    background:#f9fafb;
    padding-top:10px;
    padding-bottom:4px;
    text-align:center;
  ">
    <button id="guardarTodoTerritorios" style="
        width:100%;
        padding:12px;
        background:#16a34a;
        color:white;
        font-size:16px;
        border:none;
        border-radius:10px;
        cursor:pointer;
        font-weight:600;
        transition:background 0.2s;
      ">
      Guardar Todo
    </button>
  </div>
</div>

    <style>
      @keyframes fadeIn { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
      @keyframes fadeOut { from{opacity:1;transform:scale(1);} to{opacity:0;transform:scale(0.95);} }
      @keyframes fadeInBg { from{opacity:0;} to{opacity:1;} }
      @keyframes fadeOutBg { from{opacity:1;} to{opacity:0;} }

      #guardarTodoTerritorios:hover { background:#15803d; }
      #cerrarModalTerritorio:hover { color:#111; }
      #agregarTerritorio:hover { background:#2563eb; }
    </style>
  `;

      document.body.appendChild(modal);

      const cerrarModal = () => {
        const contenido = modal.querySelector("#modalContenido");
        contenido.style.animation = "fadeOut 0.2s forwards";
        modal.style.animation = "fadeOutBg 0.25s forwards";
        setTimeout(() => document.body.removeChild(modal), 220);
      };
      document.getElementById('cerrarModalTerritorio').addEventListener('click', cerrarModal);

      // Dropdown de territorios
      const selectedTerritorio = document.getElementById("selectedTerritorio");
      const listaTerritorios = document.getElementById("listaTerritorios");
      const cuadrasDiv = document.getElementById('cuadrasCheckbox');
      const listaAgregados = document.getElementById('listaAgregados');
      const agregarBtn = document.getElementById('agregarTerritorio');

      let registrosPendientes = [];

      window.todosLosTerritorios.forEach((t, i) => {
        const div = document.createElement("div");
        div.textContent = `Territorio ${i + 1}`;
        div.dataset.index = i;
        div.style.cssText = "padding:8px;cursor:pointer;";
        div.addEventListener("mouseover", () => div.style.background = "#f0f0f0");
        div.addEventListener("mouseout", () => div.style.background = "#fff");
        div.addEventListener("click", () => {
          selectedTerritorio.textContent = `Territorio ${i + 1}`;
          selectedTerritorio.dataset.index = i;
          listaTerritorios.style.display = "none";
          cargarCuadras(i);
        });
        listaTerritorios.appendChild(div);
      });

      selectedTerritorio.addEventListener("click", () => {
        listaTerritorios.style.display = listaTerritorios.style.display === "block" ? "none" : "block";
      });

      function cargarCuadras(idx) {
        const territorio = window.todosLosTerritorios[idx];
        const registrosGuardados = JSON.parse(localStorage.getItem(`${territorio._id}_capitanes`) || "{}");
        const fechaSeleccionada = document.getElementById('fechaTerritorio').value;
        let mesSeleccionado = null;
        let añoSeleccionado = null;

        if (fechaSeleccionada) {
          const fecha = new Date(fechaSeleccionada);
          mesSeleccionado = fecha.getMonth() + 1;
          añoSeleccionado = fecha.getFullYear();
        }

        let html = `
    <div style="margin-bottom:8px;">
      <button id="btnSeleccionarTodas" style="
        background:#10b981;
        color:white;
        border:none;
        padding:6px 10px;
        border-radius:6px;
        font-weight:bold;
        cursor:pointer;
      ">Seleccionar todas</button>
    </div>
  `;

        territorio.eachLayer(pol => {
          const cuadraLimpia = pol._id.replace(/^.*?Cuadra(\d+).*$/i, "$1").trim();
          const registro = registrosGuardados[pol._id];

          let infoExtra = "";
          if (registro && registro.length > 0) {
            const ultimo = registro[registro.length - 1];
            const match = ultimo.match(/Trabajado por: (.*?) \| Fecha: ([^|]+)(?: \| (.*))?/);

            if (match) {
              const nombre = match[1];
              const fecha = match[2];

              // Extraer mes/año del registro guardado
              const [anioReg, mesReg, diaReg] = fecha.includes("-")
                ? fecha.split("-")  // formato yyyy-mm-dd
                : fecha.split("/").reverse(); // formato dd/mm/yyyy

              const mesNum = parseInt(mesReg, 10);
              const anioNum = parseInt(anioReg, 10);

              // Mostrar solo si coincide mes/año o si no se seleccionó ninguno
              if (!mesSeleccionado || (mesSeleccionado === mesNum && añoSeleccionado === anioNum)) {
                infoExtra = `<span style="
            font-size:12px;
            color:#10b981;
            margin-left:6px;
            background:rgba(16,185,129,0.1);
            padding:2px 6px;
            border-radius:6px;
          ">${nombre} - ${fecha}</span>`;
              }
            }
          }

          html += `
      <label style="display:flex;align-items:center;margin:6px 0;color:#374151;">
        <input type="checkbox" value="${pol._id}" data-cuadra="${cuadraLimpia}" class="checkbox-cuadra" style="margin-right:6px;">
        Cuadra ${cuadraLimpia}
        ${infoExtra}
      </label>`;
        });

        cuadrasDiv.innerHTML = html;

        // ✅ Función para marcar todas las cuadras visibles
        const btnSeleccionarTodas = document.getElementById('btnSeleccionarTodas');
        btnSeleccionarTodas.addEventListener('click', () => {
          const checkboxes = cuadrasDiv.querySelectorAll('.checkbox-cuadra');

          // Solo las que tienen número válido
          const checkboxesValidas = Array.from(checkboxes).filter(cb => /^\d+$/.test(cb.dataset.cuadra));

          const todasMarcadas = checkboxesValidas.every(cb => cb.checked);

          checkboxesValidas.forEach(cb => cb.checked = !todasMarcadas);

          btnSeleccionarTodas.textContent = todasMarcadas ? 'Seleccionar todas' : 'Desmarcar todas';
        });
      }

      // 🔄 Vuelve a cargar cuadras cuando cambies la fecha
      document.getElementById('fechaTerritorio').addEventListener('change', () => {
        const idx = document.getElementById("selectedTerritorio").dataset.index;
        if (idx !== undefined) cargarCuadras(idx);
      });

      // ===== AGREGAR TERRITORIO + CUADRAS =====
      agregarBtn.addEventListener('click', () => {
        const idx = selectedTerritorio.dataset.index;
        if (idx === undefined) return alert("Selecciona un territorio primero");
        const territorio = window.todosLosTerritorios[idx];
        const capitan = document.getElementById('capitanTerritorio').value.trim();
        const fecha = document.getElementById('fechaTerritorio').value;
        const comentario = document.getElementById('comentarioTerritorio').value.trim();
        const checkboxes = cuadrasDiv.querySelectorAll('input[type=checkbox]:checked');
        if (!capitan || !fecha) return alert("Ingresa nombre y fecha");
        if (checkboxes.length === 0) return alert("Selecciona al menos una cuadra");

        // Construir registro pendiente
        const cuadrasSeleccionadas = Array.from(checkboxes).map(cb => cb.dataset.cuadra);
        registrosPendientes.push({ territorio: idx, capitan, fecha, cuadras: cuadrasSeleccionadas, comentario });

        // Guardar comentario solo por territorio
        if (comentario) {
          const comentariosTerritorio = JSON.parse(localStorage.getItem(`${territorio._id}_comentario`) || "{}");
          comentariosTerritorio[capitan] = comentario;
          localStorage.setItem(`${territorio._id}_comentario`, JSON.stringify(comentariosTerritorio));
        }

        // Crear mini-globo visual
        const globo = document.createElement('div');
        globo.style.cssText = "padding:6px 10px;background:#d1fae5;border-radius:10px;margin:4px;display:flex;align-items:center;justify-content:space-between;";

        globo.innerHTML = `
    <div style="display:flex;align-items:center;">
      ${capitan} - Territorio ${parseInt(idx) + 1}
      ${comentario ? `<span class="nota-territorio" style="margin-left:6px;cursor:pointer;color:#f59e0b;" title="Ver comentario">📝</span>` : ''}
    </div>
  `;

        // Mostrar comentario al picarle al icono 📝
        if (comentario) {
          const notaIcon = globo.querySelector('.nota-territorio');
          notaIcon.addEventListener('click', () => alert(comentario));
        }

        listaAgregados.appendChild(globo);

        // Limpiar selección para nuevo territorio
        cuadrasDiv.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
      });

      // ===== GUARDAR TODO =====
      document.getElementById('guardarTodoTerritorios').addEventListener('click', () => {
        if (registrosPendientes.length === 0) return alert("Agrega al menos un territorio y sus cuadras antes de guardar");

        registrosPendientes.forEach(reg => {
          const territorio = window.todosLosTerritorios[reg.territorio];
          const registros = JSON.parse(localStorage.getItem(`${territorio._id}_capitanes`) || "{}");

          // Guardar cuadras
          reg.cuadras.forEach(c => {
            let polId = null;
            territorio.eachLayer(pol => {
              const num = pol._id.replace(/^.*?Cuadra(\d+).*$/i, "$1").trim();
              if (num === c) polId = pol._id;
            });
            if (!polId) return;
            if (!registros[polId]) registros[polId] = [];
            const registroTexto = `Trabajado por: ${reg.capitan} | Fecha: ${reg.fecha}`;
            registros[polId].push(registroTexto);
            territorio.eachLayer(pol => { if (pol._id === polId) pol._selected = true; });
          });

          localStorage.setItem(`${territorio._id}_capitanes`, JSON.stringify(registros));
        });

        alert("Todos los registros guardados ✅");
        cerrarModal();
        registrosPendientes = [];
        listaAgregados.innerHTML = '';
      });
    });









  </script>









  <!-- Archivos externos de territorios -->

  <script src="dibujo.js"></script>

  <script src="area_grande.js"></script>
  <script src="territoriobase.js"></script>
  <script src="territorio1.js"></script>
  <script src="territorio2.js"></script>
  <script src="territorio3.js"></script>
  <script src="territorio4.js"></script>
  <script src="territorio5.js"></script>
  <script src="territorio6.js"></script>
  <script src="territorio7.js"></script>
  <script src="territorio8.js"></script>
  <script src="territorio9.js"></script>
  <script src="territorio10.js"></script>
  <script src="territorio11.js"></script>
  <script src="territorio12.js"></script>
  <script src="territorio13.js"></script>
  <script src="territorio14.js"></script>
  <script src="territorio15.js"></script>
  <script src="territorio16.js"></script>
  <script src="territorio17.js"></script>
  <script src="territorio18.js"></script>
  <script src="territorio19.js"></script>
  <script src="territorio20.js"></script>
  <script src="territorio21.js"></script>
  <script src="territorio22.js"></script>
  <script src="territorio23.js"></script>
  <script src="territorio24.js"></script>
  <script src="territorio25.js"></script>
  <script src="territorio26.js"></script>
  <script src="territorio27.js"></script>
  <script src="territorio28.js"></script>
  <script src="territorio29.js"></script>
  <script src="territorio30.js"></script>
  <script src="territorio31.js"></script>
  <script src="territorio32.js"></script>
  <script src="territorio33.js"></script>
  <script src="territorio34.js"></script>
  <script src="territorio35.js"></script>
  <script src="territorio36.js"></script>
  <script src="territorio37.js"></script>
  <script src="territorio38.js"></script>
  <script src="territorio39.js"></script>
  <script src="territorio40.js"></script>
  <script src="territorio41.js"></script>
  <script src="territorio42.js"></script>
  <script src="territorio43.js"></script>
  <script src="territorio44.js"></script>
  <script src="territorio45.js"></script>
  <script src="territorio46.js"></script>
  <script src="territorio47.js"></script>
  <script src="territorio48.js"></script>
  <script src="territorio49.js"></script>
  <script src="territorio50.js"></script>
  <script src="territorio51.js"></script>
  <script src="territorio52.js"></script>
  <script src="territorio53.js"></script>
  <script src="territorio54.js"></script>
  <script src="territorio55.js"></script>
  <script src="territorio56.js"></script>
  <script src="territorio57.js"></script>
  <script src="territorio58.js"></script>
  <script src="territorio59.js"></script>
  <script src="territorio60.js"></script>
  <script src="territorio61.js"></script>
  <script src="territorio62.js"></script>
  <script src="territorio63.js"></script>
  <script src="territorio64.js"></script>
  <script src="territorio65.js"></script>
  <script src="territorio66.js"></script>
  <script src="territorio67.js"></script>
  <script src="territorio68.js"></script>
  <script src="territorio69.js"></script>
  <script src="territorio70.js"></script>
  <script src="territorio71.js"></script>
  <script src="territorio72.js"></script>
  <script src="territorio73.js"></script>
  <script src="territorio74.js"></script>
  <script src="territorio75.js"></script>
  <script src="territorio76.js"></script>
  <script src="territorio77.js"></script>
  <script src="territorio78.js"></script>
  <script src="territorio79.js"></script>
  <script src="territorio80.js"></script>
  <script src="territorio81.js"></script>
  <script src="territorio82.js"></script>
  <script src="territorio83.js"></script>
  <script src="territorio84.js"></script>
  <script src="territorionegocios.js"></script>


</body>

</html>